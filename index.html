<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina Doméstica - Sistema Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans">

    <div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-file-invoice-dollar text-blue-600 mr-3"></i>Generar Rol de Pagos
            </h2>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-md mb-6 text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">Empleador</p>
                        <p class="font-semibold text-gray-800">DYLAN VELEZ</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold">Trabajadora</p>
                        <p class="font-semibold text-gray-800">MONICA MATUTE</p>
                    </div>
                    <div class="col-span-2 mt-2">
                        <p class="text-xs text-gray-500 uppercase font-bold">Configuración Salarial</p>
                        <p class="text-gray-700">Sueldo Base (4.5h): <span class="font-bold">$264.38</span> | SBU 2025: <span class="font-bold">$470.00</span></p>
                    </div>
                </div>
            </div>

            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Mes del Rol</label>
                        <input type="month" id="mesPago" class="w-full border-gray-300 border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Fecha Emisión</label>
                        <input type="date" id="fechaEmision" class="w-full border-gray-300 border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none transition">
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Días Trab.</label>
                        <input type="number" id="diasTrab" value="30" min="1" max="30" class="w-full border-gray-300 border rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-blue-900">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 mb-1">Extras ($)</label>
                        <input type="number" id="extras" value="0.00" step="0.01" class="w-full border-gray-300 border rounded-lg p-2.5 outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-red-600 mb-1">Préstamos ($)</label>
                        <input type="number" id="prestamos" value="0.00" step="0.01" class="w-full border-red-200 bg-red-50 border rounded-lg p-2.5 outline-none text-red-700">
                    </div>
                </div>

                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg border">
                    <div>
                        <span class="block text-sm font-bold text-gray-700">Pagar Décimos Mensuales</span>
                        <span class="text-xs text-gray-500">Calcula 13ro y 14to proporcional</span>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="pagarDecimos" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>

                <div class="bg-slate-800 text-white rounded-xl p-5 shadow-lg space-y-2">
                    <div class="flex justify-between text-sm opacity-80">
                        <span>Sueldo Proporcional:</span>
                        <span id="lblSueldo">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm text-green-400" id="rowDecimos">
                        <span>+ Décimos (13ro + 14to):</span>
                        <span id="lblDecimos">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm text-red-300">
                        <span>- Aporte IESS (9.45%):</span>
                        <span id="lblIess">$0.00</span>
                    </div>
                    <div class="flex justify-between text-sm text-red-300">
                        <span>- Préstamos:</span>
                        <span id="lblPrestamos">$0.00</span>
                    </div>
                    <div class="h-px bg-slate-600 my-2"></div>
                    <div class="flex justify-between text-xl font-bold items-center">
                        <span>A TRANSFERIR:</span>
                        <span id="lblLiquido" class="text-2xl text-green-400">$0.00</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button onclick="generarPDF()" class="flex items-center justify-center bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                        <i class="fas fa-file-pdf mr-2"></i> PDF para Firmar
                    </button>
                    <button onclick="guardarRegistro()" class="flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                        <i class="fas fa-save mr-2"></i> Guardar Mes
                    </button>
                </div>
            </div>
        </div>

        <div class="flex flex-col h-full space-y-6">
            <div class="bg-white rounded-2xl shadow-xl p-6 border border-gray-100 flex-grow">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-gray-800"><i class="fas fa-history mr-2 text-gray-500"></i>Historial de Pagos</h3>
                    <button onclick="exportarExcel()" class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded-full font-bold hover:bg-green-200 transition">
                        <i class="fas fa-file-excel mr-1"></i> Exportar Todo
                    </button>
                </div>
                
                <div class="overflow-y-auto max-h-[500px] pr-2">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs sticky top-0">
                            <tr>
                                <th class="p-3 rounded-tl-lg">Mes</th>
                                <th class="p-3">Días</th>
                                <th class="p-3">Total ($)</th>
                                <th class="p-3 text-right rounded-tr-lg">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tablaHistorial" class="divide-y divide-gray-100">
                            </tbody>
                    </table>
                    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-10 text-gray-400">
                        <i class="fas fa-folder-open text-4xl mb-3 opacity-30"></i>
                        <p>No hay roles guardados</p>
                    </div>
                </div>
            </div>
            
            <button onclick="borrarTodo()" class="text-xs text-red-400 hover:text-red-600 underline text-center w-full pb-4">
                Borrar base de datos local
            </button>
        </div>
    </div>

    <script>
        // === CONFIGURACIÓN MAESTRA ===
        const CONFIG = {
            empleador: { nombre: "DYLAN JOEL VELEZ VILLASAGUA", ci: "0926413667" },
            trabajador: { nombre: "MONICA ALEXANDRA MATUTE IBARRA", ci: "0201600202", cargo: "EMPLEADA DOMÉSTICA" },
            direccion: "AV. DR. HUMBERTO DEL POZO SALTOS (SECTOR HUMBERDINA)",
            sbu2025: 470.00,       // Salario Básico Unificado 2025
            sueldoContrato: 264.38 // Sueldo fijo por 4.5 horas (Mes completo)
        };

        // === INICIALIZACIÓN ===
        window.onload = () => {
            const hoy = new Date();
            document.getElementById('mesPago').value = hoy.toISOString().slice(0, 7);
            document.getElementById('fechaEmision').value = hoy.toISOString().slice(0, 10);
            renderHistorial();
            calcular();
        };

        document.querySelectorAll('input').forEach(el => el.addEventListener('input', calcular));
        document.getElementById('pagarDecimos').addEventListener('change', calcular);

        // === MOTOR DE CÁLCULO ===
        function calcular() {
            const dias = parseInt(document.getElementById('diasTrab').value) || 0;
            const extras = parseFloat(document.getElementById('extras').value) || 0;
            const prestamos = parseFloat(document.getElementById('prestamos').value) || 0;
            const pagaDecimos = document.getElementById('pagarDecimos').checked;

            // 1. Sueldo Proporcional (Regla de 3: Si 30 días es 264.38, X días es...)
            // NOTA: Para diciembre usas 16 días.
            let sueldoGanado = (CONFIG.sueldoContrato / 30) * dias;

            // 2. Décimos
            let decimo3 = 0; // Todo lo ganado / 12
            let decimo4 = 0; // SBU / 12 (proporcional a días trabajados)

            if (pagaDecimos) {
                decimo3 = (sueldoGanado + extras) / 12;
                // Fórmula D4: (SBU / 12 meses) / 30 días * días trabajados
                let d4MensualCompleto = CONFIG.sbu2025 / 12;
                decimo4 = (d4MensualCompleto / 30) * dias;
            }

            // 3. IESS (9.45% solo del sueldo + extras, NO de décimos)
            let iess = (sueldoGanado + extras) * 0.0945;

            // 4. Líquido
            let totalDecimos = decimo3 + decimo4;
            let liquido = (sueldoGanado + extras + totalDecimos) - iess - prestamos;

            // Renderizar en Pantalla
            document.getElementById('lblSueldo').innerText = `$ ${sueldoGanado.toFixed(2)}`;
            document.getElementById('lblDecimos').innerText = `$ ${totalDecimos.toFixed(2)}`;
            document.getElementById('lblIess').innerText = `$ ${iess.toFixed(2)}`;
            document.getElementById('lblPrestamos').innerText = `$ ${prestamos.toFixed(2)}`;
            document.getElementById('lblLiquido').innerText = `$ ${liquido.toFixed(2)}`;

            // Retornamos valores para usar en PDF
            return { sueldoGanado, extras, decimo3, decimo4, totalDecimos, iess, prestamos, liquido, dias };
        }

        // === GENERADOR PDF ===
        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const data = calcular();
            
            const mesInput = document.getElementById('mesPago').value;
            const [anio, mes] = mesInput.split('-');
            const nombreMes = new Date(anio, mes - 1).toLocaleString('es-ES', { month: 'long' }).toUpperCase();

            // Encabezado
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("ROL DE PAGOS", 105, 20, null, null, 'center');
            doc.setFontSize(11);
            doc.text(`PERÍODO: ${nombreMes} ${anio}`, 105, 27, null, null, 'center');

            // Recuadro Datos
            doc.setLineWidth(0.1);
            doc.rect(15, 35, 180, 35);
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            
            doc.text(`EMPLEADOR: ${CONFIG.empleador.nombre}`, 20, 42);
            doc.text(`RUC/C.I.: ${CONFIG.empleador.ci}`, 20, 47);
            doc.text(`DIRECCIÓN: ${CONFIG.direccion}`, 20, 52);

            doc.text(`TRABAJADORA: ${CONFIG.trabajador.nombre}`, 20, 60);
            doc.text(`C.I.: ${CONFIG.trabajador.ci}`, 120, 60);
            doc.text(`CARGO: ${CONFIG.trabajador.cargo}`, 20, 65);
            doc.text(`DÍAS TRABAJADOS: ${data.dias}`, 120, 65);

            // Tabla Detalle
            let y = 80;
            // Header Tabla
            doc.setFillColor(240, 240, 240);
            doc.rect(15, y, 180, 8, 'F');
            doc.setFont("helvetica", "bold");
            doc.text("RUBROS", 20, y+5);
            doc.text("INGRESOS", 120, y+5, null, null, 'right');
            doc.text("DESCUENTOS", 170, y+5, null, null, 'right');

            y += 15;
            doc.setFont("helvetica", "normal");

            // Filas
            doc.text(`Sueldo (${data.dias} días)`, 20, y);
            doc.text(data.sueldoGanado.toFixed(2), 120, y, null, null, 'right');

            if(data.extras > 0) {
                y += 6;
                doc.text("Horas Suplementarias", 20, y);
                doc.text(data.extras.toFixed(2), 120, y, null, null, 'right');
            }

            if(data.totalDecimos > 0) {
                y += 6;
                doc.text(`Décimo Tercero (Proporcional)`, 20, y);
                doc.text(data.decimo3.toFixed(2), 120, y, null, null, 'right');
                y += 6;
                doc.text(`Décimo Cuarto (Proporcional)`, 20, y);
                doc.text(data.decimo4.toFixed(2), 120, y, null, null, 'right');
            }

            y += 6;
            doc.text("Aporte Personal IESS (9.45%)", 20, y);
            doc.text(data.iess.toFixed(2), 170, y, null, null, 'right');

            if(data.prestamos > 0) {
                y += 6;
                doc.text("Préstamos / Anticipos", 20, y);
                doc.text(data.prestamos.toFixed(2), 170, y, null, null, 'right');
            }

            // Total Líquido
            y += 10;
            doc.setDrawColor(0);
            doc.line(15, y, 195, y);
            y += 8;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("TOTAL A RECIBIR:", 20, y);
            doc.text(`$ ${data.liquido.toFixed(2)}`, 170, y, null, null, 'right');

            // Firmas
            y += 35;
            doc.setFontSize(8);
            doc.setFont("helvetica", "normal");
            
            doc.line(25, y, 85, y);
            doc.text("FIRMA EMPLEADOR", 55, y+4, null, null, 'center');
            doc.text(CONFIG.empleador.ci, 55, y+8, null, null, 'center');

            doc.line(125, y, 185, y);
            doc.text("RECIBÍ CONFORME", 155, y+4, null, null, 'center');
            doc.text(CONFIG.trabajador.ci, 155, y+8, null, null, 'center');

            doc.save(`Rol_${nombreMes}_${anio}.pdf`);
        }

        // === GESTIÓN DE DATOS (LOCALSTORAGE) ===
        function guardarRegistro() {
            const data = calcular();
            const mesVal = document.getElementById('mesPago').value;
            
            const registro = {
                id: Date.now(),
                mes: mesVal,
                fecha: document.getElementById('fechaEmision').value,
                dias: data.dias,
                total: data.liquido.toFixed(2),
                detalle: data 
            };

            let historial = JSON.parse(localStorage.getItem('nominaDB')) || [];
            // Verificar si ya existe el mes
            const existe = historial.findIndex(r => r.mes === mesVal);
            if(existe >= 0) {
                if(!confirm("Ya existe un rol guardado para este mes. ¿Deseas sobrescribirlo?")) return;
                historial[existe] = registro;
            } else {
                historial.push(registro);
            }
            
            localStorage.setItem('nominaDB', JSON.stringify(historial));
            renderHistorial();
            alert("✅ Rol guardado exitosamente");
        }

        function renderHistorial() {
            const historial = JSON.parse(localStorage.getItem('nominaDB')) || [];
            const tbody = document.getElementById('tablaHistorial');
            const empty = document.getElementById('emptyState');
            
            tbody.innerHTML = '';
            
            if(historial.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            // Ordenar: Mes más reciente arriba
            historial.sort((a, b) => b.mes.localeCompare(a.mes));

            historial.forEach(item => {
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 transition";
                row.innerHTML = `
                    <td class="p-3 font-medium text-gray-700">${item.mes}</td>
                    <td class="p-3 text-gray-500">${item.dias}</td>
                    <td class="p-3 font-bold text-green-600">$${item.total}</td>
                    <td class="p-3 text-right">
                        <button onclick="eliminarRegistro(${item.id})" class="text-red-400 hover:text-red-600 p-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function eliminarRegistro(id) {
            if(!confirm("¿Eliminar este registro?")) return;
            let historial = JSON.parse(localStorage.getItem('nominaDB')) || [];
            historial = historial.filter(x => x.id !== id);
            localStorage.setItem('nominaDB', JSON.stringify(historial));
            renderHistorial();
        }

        function borrarTodo() {
            if(confirm("⚠ ¿Estás seguro de borrar TODA la base de datos?")) {
                localStorage.removeItem('nominaDB');
                renderHistorial();
            }
        }

        function exportarExcel() {
            const historial = JSON.parse(localStorage.getItem('nominaDB')) || [];
            if(historial.length === 0) return alert("No hay datos para exportar");

            const dataExport = historial.map(r => ({
                "Mes": r.mes,
                "Fecha Emisión": r.fecha,
                "Días Trabajados": r.dias,
                "Sueldo Ganado": r.detalle.sueldoGanado,
                "Horas Extras": r.detalle.extras,
                "Décimo 3ro": r.detalle.decimo3,
                "Décimo 4to": r.detalle.decimo4,
                "Aporte IESS": r.detalle.iess,
                "Préstamos": r.detalle.prestamos,
                "LÍQUIDO A PAGAR": parseFloat(r.total)
            }));

            const ws = XLSX.utils.json_to_sheet(dataExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Historial Nómina");
            XLSX.writeFile(wb, "Reporte_Nomina_Completo.xlsx");
        }
    </script>
</body>
</html>
