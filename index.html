<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina Doméstica Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Fondo de seguridad (puntitos) */
        .security-bg {
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 10px 10px;
        }
        /* Spinner de carga */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #10b981;
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos para filas anuladas */
        .row-anulado { background-color: #fee2e2 !important; color: #991b1b; text-decoration: line-through; }
        .row-anulado .no-strike { text-decoration: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans text-slate-800">

    <div id="loadingOverlay" class="fixed inset-0 bg-white/80 z-50 hidden flex-col items-center justify-center">
        <div class="loader mb-2"></div>
        <p class="text-sm font-bold text-emerald-600">Procesando...</p>
    </div>

    <nav class="bg-slate-900 text-white p-4 rounded-xl shadow-lg max-w-6xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="font-bold text-lg flex items-center gap-2">
            <i class="fas fa-file-invoice-dollar text-emerald-400"></i>
            <span>Nómina <span class="text-emerald-400 font-light">SecureCloud</span></span>
        </h1>
        <button onclick="cargarHistorial()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded transition border border-slate-600">
            <i class="fas fa-sync-alt mr-1"></i> Recargar Datos
        </button>
    </nav>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">

        <div class="bg-white rounded-xl shadow-xl border-t-4 border-slate-800 overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <h2 class="font-bold text-slate-700">Nuevo Rol de Pagos</h2>
                <span id="hashDisplay" class="text-[10px] font-mono bg-emerald-100 text-emerald-800 px-2 py-1 rounded border border-emerald-200">Generating...</span>
            </div>

            <div class="p-6 space-y-4 relative security-bg">
                <div class="text-xs bg-white/90 p-3 rounded border shadow-sm space-y-1">
                    <p><strong>Empleador:</strong> <span id="lblEmpleador">DYLAN JOEL VELEZ VILLASAGUA</span></p>
                    <p><strong>Trabajadora:</strong> <span id="lblTrabajador">MONICA ALEXANDRA MATUTE IBARRA</span></p>
                </div>

                <div class="bg-blue-50/90 p-3 rounded border border-blue-100">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-bold text-blue-800 uppercase">Período Laboral</span>
                        <span class="text-xs bg-white px-2 py-0.5 rounded text-blue-600 border border-blue-200 font-bold">
                            Días: <span id="lblDias">0</span>
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="fechaIni" class="w-full text-xs border rounded p-1.5 focus:ring-2 focus:ring-blue-400 outline-none">
                        <input type="date" id="fechaFin" class="w-full text-xs border rounded p-1.5 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-600">Horas Extras ($)</label>
                        <input type="number" id="valExtras" value="0.00" class="w-full text-sm border rounded p-2 focus:border-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600">Préstamos ($)</label>
                        <input type="number" id="valPrestamos" value="0.00" class="w-full text-sm border border-red-200 bg-red-50 text-red-600 rounded p-2 outline-none">
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border">
                    <input type="checkbox" id="checkDecimos" class="text-emerald-600 rounded focus:ring-emerald-500">
                    <label for="checkDecimos" class="text-xs font-bold text-gray-700 cursor-pointer select-none">Incluir Décimos (Acumulados)</label>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500">Fecha de Firma (Emisión)</label>
                    <input type="date" id="fechaEmision" class="w-full text-xs border rounded p-1.5">
                </div>

                <div class="bg-slate-800 text-white p-4 rounded-lg shadow text-sm space-y-1">
                    <div class="flex justify-between text-gray-400 text-xs"><span>Sueldo Base:</span> <span id="outSueldo">$0.00</span></div>
                    <div id="rowDecimos" class="hidden flex justify-between text-emerald-400 text-xs"><span>+ Décimos:</span> <span id="outDecimos">$0.00</span></div>
                    <div class="flex justify-between text-red-300 text-xs"><span>- IESS (9.45%):</span> <span id="outIess">$0.00</span></div>
                    <div class="flex justify-between text-red-300 text-xs"><span>- Préstamos:</span> <span id="outPrestamos">$0.00</span></div>
                    <div class="border-t border-slate-600 my-2"></div>
                    <div class="flex justify-between font-bold text-lg text-yellow-400">
                        <span>A RECIBIR:</span> <span id="outLiquido">$0.00</span>
                    </div>
                </div>

                <button onclick="guardarYGenerar()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-barcode"></i> Guardar y Generar PDF
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl border-t-4 border-blue-600 flex flex-col h-[600px]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="fas fa-database text-blue-600"></i> Historial Cloud
                </h2>
                <input type="text" id="buscador" placeholder="Buscar..." class="text-xs border rounded px-2 py-1 w-32" onkeyup="filtrarTabla()">
            </div>

            <div class="flex-1 overflow-auto bg-slate-50 p-2">
                <table class="w-full text-xs text-left border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
                    <thead class="bg-slate-200 text-slate-700 font-bold uppercase sticky top-0">
                        <tr>
                            <th class="p-3">Periodo / Hash</th>
                            <th class="p-3 text-right">Liquido</th>
                            <th class="p-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCuerpo" class="divide-y divide-gray-100">
                        </tbody>
                </table>
                <div id="emptyState" class="hidden text-center p-10 text-gray-400">
                    <i class="fas fa-cloud-download-alt text-3xl mb-2"></i>
                    <p>Cargando datos...</p>
                </div>
            </div>
        </div>
    </div>

    <canvas id="barcodeCanvas" class="hidden"></canvas>

    <script>
        // ==========================================
        // CONFIGURACIÓN (Pega tu URL Aquí)
        // ==========================================
        const URL_APPS_SCRIPT = "TU_URL_DE_APPS_SCRIPT_QUE_TERMINA_EN_EXEC";

        // Datos Constantes
        const DATOS = {
            empleador: { nombre: "DYLAN JOEL VELEZ VILLASAGUA", ci: "0926413667" },
            trabajador: { nombre: "MONICA ALEXANDRA MATUTE IBARRA", ci: "0201600202" },
            sueldoBase: 264.38,
            sbu: 470.00
        };

        let hashActual = "";
        let dbLocal = []; // Cache para búsqueda rápida

        // ==========================================
        // INICIO
        // ==========================================
        window.onload = () => {
            const hoy = new Date();
            // Default: primer día del mes al día actual
            document.getElementById('fechaIni').valueAsDate = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            document.getElementById('fechaFin').valueAsDate = hoy;
            document.getElementById('fechaEmision').valueAsDate = hoy;
            
            generarNuevoHash();
            calcular();
            cargarHistorial(); // Cargar datos de la nube
        };

        // ==========================================
        // LÓGICA DE CÁLCULO
        // ==========================================
        function generarNuevoHash() {
            const rand = Math.random().toString(36).substring(2, 6).toUpperCase();
            const mes = (new Date().getMonth() + 1).toString().padStart(2, '0');
            hashActual = `ROL-${mes}-${rand}`;
            document.getElementById('hashDisplay').innerText = hashActual;
        }

        // Event Listeners
        ['fechaIni', 'fechaFin'].forEach(id => document.getElementById(id).addEventListener('change', calcular));
        ['valExtras', 'valPrestamos', 'checkDecimos'].forEach(id => document.getElementById(id).addEventListener('input', calcular));

        function calcular() {
            // 1. Días
            const d1 = new Date(document.getElementById('fechaIni').value);
            const d2 = new Date(document.getElementById('fechaFin').value);
            let dias = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
            if (dias < 0) dias = 0;
            document.getElementById('lblDias').innerText = dias;

            // 2. Valores
            const extras = parseFloat(document.getElementById('valExtras').value) || 0;
            const prestamos = parseFloat(document.getElementById('valPrestamos').value) || 0;
            const conDecimos = document.getElementById('checkDecimos').checked;

            // Cálculos
            const sueldoGanado = (DATOS.sueldoBase / 30) * dias;
            let dec3 = 0, dec4 = 0;
            
            if (conDecimos) {
                dec3 = (sueldoGanado + extras) / 12;
                dec4 = (DATOS.sbu / 360) * dias;
                document.getElementById('rowDecimos').classList.remove('hidden');
            } else {
                document.getElementById('rowDecimos').classList.add('hidden');
            }

            const iess = (sueldoGanado + extras) * 0.0945;
            const liquido = (sueldoGanado + extras + dec3 + dec4) - iess - prestamos;

            // Render
            document.getElementById('outSueldo').innerText = `$${sueldoGanado.toFixed(2)}`;
            document.getElementById('outDecimos').innerText = `$${(dec3 + dec4).toFixed(2)}`;
            document.getElementById('outIess').innerText = `$${iess.toFixed(2)}`;
            document.getElementById('outPrestamos').innerText = `$${prestamos.toFixed(2)}`;
            document.getElementById('outLiquido').innerText = `$${liquido.toFixed(2)}`;

            // Retornar objeto completo para guardar
            return {
                dias, sueldoGanado, extras, dec3, dec4, iess, prestamos, liquido,
                periodoTxt: `${document.getElementById('fechaIni').value} al ${document.getElementById('fechaFin').value}`,
                emision: document.getElementById('fechaEmision').value
            };
        }

        // ==========================================
        // CONEXIÓN CON GOOGLE SHEETS
        // ==========================================
        async function cargarHistorial() {
            setLoading(true);
            try {
                const res = await fetch(URL_APPS_SCRIPT, { method: 'POST', body: JSON.stringify({ accion: 'leer' }) });
                const json = await res.json();
                if (json.result === 'success') {
                    dbLocal = json.data;
                    renderTabla(dbLocal);
                }
            } catch (e) { console.error(e); alert("Error cargando historial"); }
            setLoading(false);
        }

        async function guardarYGenerar() {
            if(URL_APPS_SCRIPT.includes("TU_URL")) return alert("¡Configura la URL del Script!");
            
            const calcs = calcular();
            if (calcs.dias <= 0) return alert("Revisa las fechas");
            
            setLoading(true);

            // 1. Preparar Payload (La Data Completa)
            const payload = {
                hash: hashActual,
                periodo_txt: calcs.periodoTxt,
                monto: calcs.liquido.toFixed(2),
                detalle_completo: { ...calcs, ...DATOS } // Guardamos TODO
            };

            try {
                // 2. Enviar a Google Sheets
                const res = await fetch(URL_APPS_SCRIPT, { 
                    method: 'POST', 
                    body: JSON.stringify({ accion: 'guardar', payload: payload }) 
                });
                const json = await res.json();
                
                if (json.result === 'success') {
                    // 3. Generar PDF
                    generarPDF(payload.detalle_completo, hashActual, 'ACTIVO');
                    // 4. Actualizar UI
                    generarNuevoHash();
                    cargarHistorial(); // Recarga la tabla
                } else {
                    alert("Error guardando: " + json.msg);
                }
            } catch (e) { alert("Error de conexión"); }
            setLoading(false);
        }

        async function anularRol(hash) {
            if (!confirm("¿Seguro que quieres ANULAR este rol?")) return;
            setLoading(true);
            try {
                const res = await fetch(URL_APPS_SCRIPT, { 
                    method: 'POST', 
                    body: JSON.stringify({ accion: 'anular', hash: hash }) 
                });
                const json = await res.json();
                if (json.result === 'success') {
                    cargarHistorial();
                } else {
                    alert(json.msg);
                }
            } catch (e) { alert("Error anulando"); }
            setLoading(false);
        }

        // ==========================================
        // GENERACIÓN DE PDF
        // ==========================================
        function generarPDF(data, hash, estado) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // 1. Fondo de Seguridad (Tramado)
            doc.setFillColor(245, 245, 245);
            for(let i=0; i<300; i+=10) {
                for(let j=0; j<300; j+=10) {
                    doc.circle(i, j, 0.5, 'F');
                }
            }

            // 2. Marca de Agua ANULADO
            if (estado === 'ANULADO') {
                doc.setTextColor(255, 200, 200);
                doc.setFontSize(60);
                doc.setFont("helvetica", "bold");
                doc.text("ANULADO", 50, 150, { angle: 45 });
                doc.setTextColor(0,0,0); // Reset color
            }

            // 3. Encabezado
            doc.setFontSize(16); doc.setFont("helvetica", "bold");
            doc.text("ROL DE PAGOS - SERVICIO DOMÉSTICO", 105, 20, null, null, "center");
            
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text(`CÓDIGO ÚNICO: ${hash}`, 105, 27, null, null, "center");
            doc.text(`PERÍODO: ${data.periodoTxt}`, 105, 33, null, null, "center");

            // 4. Datos Personales
            doc.setDrawColor(0); doc.setFillColor(255, 255, 255);
            doc.rect(15, 40, 180, 25, 'FD');
            
            doc.setFontSize(9);
            doc.text(`EMPLEADOR: ${data.empleador.nombre}`, 20, 48);
            doc.text(`CI: ${data.empleador.ci}`, 20, 53);
            
            doc.text(`TRABAJADORA: ${data.trabajador.nombre}`, 20, 60);
            doc.text(`CI: ${data.trabajador.ci}`, 140, 60);

            // 5. Tabla Detalles
            let y = 75;
            doc.setFillColor(30, 41, 59); // Slate 800
            doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255); doc.setFont("helvetica", "bold");
            doc.text("RUBRO", 20, y+5); doc.text("MONTO", 185, y+5, null, null, "right");
            
            y += 15; doc.setTextColor(0); doc.setFont("helvetica", "normal");
            
            const row = (label, val) => {
                doc.text(label, 20, y);
                doc.text(parseFloat(val).toFixed(2), 185, y, null, null, "right");
                y += 7;
            };

            row(`Sueldo Proporcional (${data.dias} días)`, data.sueldoGanado);
            if(data.extras > 0) row("Horas Extras (+)", data.extras);
            if((data.dec3 + data.dec4) > 0) row("Décimos Acumulados (+)", data.dec3 + data.dec4);
            row("Aporte IESS 9.45% (-)", data.iess);
            if(data.prestamos > 0) row("Préstamos (-)", data.prestamos);

            // Total
            y += 5; doc.setLineWidth(0.5); doc.line(15, y, 195, y); y += 10;
            doc.setFontSize(12); doc.setFont("helvetica", "bold");
            doc.text("LÍQUIDO A RECIBIR:", 20, y);
            doc.text(`$ ${parseFloat(data.liquido).toFixed(2)}`, 185, y, null, null, "right");

            // 6. CÓDIGO DE BARRAS (GENERADO AL VUELO)
            const canvas = document.createElement("canvas");
            JsBarcode(canvas, hash, { format: "CODE128", displayValue: false });
            const barcodeImg = canvas.toDataURL("image/jpeg");
            
            y += 20;
            doc.addImage(barcodeImg, 'JPEG', 70, y, 70, 15);
            doc.setFontSize(8); doc.setFont("helvetica", "normal");
            doc.text("Firma Digital del Documento", 105, y+20, null, null, "center");
            doc.text(`Emisión: ${data.emision}`, 105, y+25, null, null, "center");

            // 7. Firmas
            y += 40;
            doc.line(30, y, 80, y); doc.line(130, y, 180, y);
            doc.text("EMPLEADOR", 55, y+5, null, null, "center");
            doc.text("RECIBÍ CONFORME", 155, y+5, null, null, "center");

            doc.save(`Rol_${hash}.pdf`);
        }

        // ==========================================
        // UTILIDADES UI
        // ==========================================
        function setLoading(state) {
            document.getElementById('loadingOverlay').style.display = state ? 'flex' : 'none';
        }

        function renderTabla(datos) {
            const tbody = document.getElementById('tablaCuerpo');
            tbody.innerHTML = '';
            
            if(datos.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            document.getElementById('emptyState').classList.add('hidden');

            datos.forEach(item => {
                const tr = document.createElement('tr');
                const esAnulado = item.estado === 'ANULADO';
                tr.className = `border-b hover:bg-slate-50 transition ${esAnulado ? 'row-anulado' : ''}`;
                
                // Preparamos el JSON para pasarlo a la función de imprimir
                // Nota: item.json viene de Apps Script como string, hay que parsearlo
                let dataObj = null;
                try { dataObj = JSON.parse(item.json); } catch(e) { dataObj = {}; }
                
                // Importante: Escapamos comillas para el HTML inline onclick
                const dataStr = JSON.stringify(dataObj).replace(/"/g, '&quot;');

                tr.innerHTML = `
                    <td class="p-3">
                        <div class="font-bold text-slate-700 text-xs">${item.periodo}</div>
                        <div class="font-mono text-[10px] text-slate-500 mt-1 flex items-center gap-2">
                            <span>${item.hash}</span>
                            ${esAnulado ? '<span class="text-red-600 font-bold px-1 border border-red-200 rounded no-strike">ANULADO</span>' : ''}
                        </div>
                    </td>
                    <td class="p-3 text-right font-bold text-slate-800">$${item.liquido}</td>
                    <td class="p-3 text-center no-strike">
                        <button onclick="generarPDF(${dataStr}, '${item.hash}', '${item.estado}')" class="text-blue-500 hover:text-blue-700 mx-1" title="Descargar PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        ${!esAnulado ? 
                        `<button onclick="anularRol('${item.hash}')" class="text-red-400 hover:text-red-600 mx-1" title="Anular">
                            <i class="fas fa-ban"></i>
                        </button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function filtrarTabla() {
            const term = document.getElementById('buscador').value.toLowerCase();
            const filtrados = dbLocal.filter(x => x.hash.toLowerCase().includes(term) || x.periodo.toLowerCase().includes(term));
            renderTabla(filtrados);
        }
    </script>
</body>
</html>
