<!DOCTYPE html>
<html lang="es" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina Doméstica 2025 | Premium</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                    mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                },
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' } // Un tono más oscuro personalizado
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background-color: #f1f5f9; /* Slate 100 más limpio */ }
        
        /* Spinner de carga mejorado */
        .loader { border: 3px solid rgba(16, 185, 129, 0.2); border-top: 3px solid #10b981; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Estilos para filas anuladas */
        .row-anulado { background-color: #fef2f2 !important; /* Red 50 */ color: #991b1b; }
        .row-anulado .cell-content { text-decoration: line-through; opacity: 0.7; }
        .no-strike { text-decoration: none !important; opacity: 1 !important; }

        /* Inputs personalizados */
        .input-modern { @apply w-full text-sm border-slate-200 rounded-lg p-2.5 transition-all duration-200 focus:ring-2 focus:ring-emerald-500/20 focus:border-emerald-500 outline-none shadow-sm; }
        .label-modern { @apply block text-xs font-semibold text-slate-600 mb-1.5 ml-1; }
        
        /* Scrollbar personalizada para la tabla */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 font-sans text-slate-800 bg-slate-100/50">

    <div id="loadingOverlay" class="fixed inset-0 bg-white/60 backdrop-blur-sm z-50 hidden flex-col items-center justify-center transition-all">
        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center">
            <div class="loader mb-4"></div>
            <p class="text-sm font-semibold text-slate-700">Procesando, por favor espere...</p>
        </div>
    </div>

    <nav class="bg-slate-850 text-white p-4 rounded-2xl shadow-lg shadow-slate-200/50 max-w-6xl mx-auto mb-8 flex flex-col sm:flex-row justify-between items-center gap-4 border-b border-slate-700/50">
        <div>
            <h1 class="font-bold text-xl flex items-center gap-3">
                <div class="bg-emerald-500/10 p-2 rounded-lg ring-1 ring-emerald-500/20">
                    <i class="fas fa-shield-alt text-emerald-400"></i>
                </div>
                <span class="tracking-tight">Nómina <span class="text-emerald-400 font-light">SecureCloud</span> 2025</span>
            </h1>
            <p class="text-xs text-slate-400 mt-1 ml-12">Sistema de Liquidación Doméstica</p>
        </div>
        <button onclick="cargarHistorial()" class="text-sm bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2.5 rounded-xl transition-all duration-200 border border-slate-600 flex items-center gap-2 shadow-sm hover:shadowActive:scale-95">
            <i class="fas fa-sync-alt text-emerald-400 animate-spin-slow"></i> Sincronizar Datos
        </button>
    </nav>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">

        <div class="lg:col-span-7 bg-white rounded-3xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] border border-slate-100 overflow-hidden transition-all hover:shadow-[0_8px_30px_-6px_rgba(0,0,0,0.12)]">
            
            <div class="px-6 py-5 bg-white border-b border-slate-100 flex justify-between items-center">
                <div>
                    <h2 class="font-bold text-lg text-slate-800">Nueva Liquidación</h2>
                    <p class="text-xs text-slate-500">Cierre Fiscal Diciembre 2025</p>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] uppercase font-bold text-slate-400 mb-1">Hash de Transacción</span>
                    <span id="hashDisplay" class="text-xs font-mono bg-emerald-50 text-emerald-700 px-3 py-1.5 rounded-lg border border-emerald-100 shadow-sm tracking-wider">Generating...</span>
                </div>
            </div>

            <div class="p-6 space-y-6">
                
                <div class="bg-slate-50/80 p-5 rounded-2xl border border-slate-200/60 flex flex-col sm:flex-row gap-4 items-start sm:items-center relative overflow-hidden">
                    <div class="absolute -right-4 -top-4 text-slate-200/50 text-8xl z-0"><i class="fas fa-user-tie"></i></div>
                    
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100 z-10">
                        <i class="fas fa-user-circle text-4xl text-slate-300"></i>
                    </div>
                    <div class="flex-1 z-10 space-y-1">
                         <p class="text-xs text-slate-500 font-medium uppercase">Trabajadora</p>
                        <p id="lblTrabajador" class="text-sm font-bold text-slate-800 leading-tight">MONICA ALEXANDRA MATUTE IBARRA</p>
                        
                        <div class="flex flex-wrap gap-2 mt-3">
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[11px] font-medium bg-blue-50 text-blue-700 border border-blue-100">
                                <i class="fas fa-clock text-blue-500"></i> 5.5 Horas/día
                            </span>
                            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[11px] font-medium bg-emerald-50 text-emerald-700 border border-emerald-100">
                                <i class="fas fa-money-bill-wave text-emerald-500"></i> Sueldo: $264.38
                            </span>
                             <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-[11px] font-medium bg-purple-50 text-purple-700 border border-purple-100">
                                <i class="fas fa-balance-scale text-purple-500"></i> SBU '25: $470
                            </span>
                        </div>
                    </div>
                    <div class="hidden">
                         <span id="lblEmpleador">DYLAN JOEL VELEZ VILLASAGUA</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="label-modern text-sm flex items-center gap-2">
                            <i class="far fa-calendar-alt text-blue-500"></i> Período a Liquidar
                        </label>
                         <span class="text-xs font-medium bg-blue-50 text-blue-600 px-3 py-1 rounded-full border border-blue-100">
                            <span id="lblDias" class="font-bold text-sm">0</span> Días calculados
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"><i class="fas fa-chevron-right"></i> Desde:</span>
                            <input type="date" id="fechaIni" class="input-modern pl-16 font-medium text-slate-700">
                        </div>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"><i class="fas fa-chevron-left"></i> Hasta:</span>
                            <input type="date" id="fechaFin" class="input-modern pl-16 font-medium text-slate-700">
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-100 my-6"></div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="space-y-3">
                         <h3 class="text-xs font-bold text-emerald-700 uppercase tracking-wider flex items-center gap-2 mb-4">
                             <i class="fas fa-plus-circle"></i> Adicionales
                         </h3>
                        <div>
                            <label for="valExtras" class="label-modern">Horas Extras (Valor $)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                                <input type="number" id="valExtras" value="0.00" min="0" step="0.01" class="input-modern pl-8" placeholder="0.00">
                            </div>
                        </div>
                         <div class="pt-2">
                            <label class="flex items-center p-3 rounded-xl border border-slate-200 bg-white hover:border-emerald-300 transition-colors cursor-pointer shadow-sm group">
                                <input type="checkbox" id="checkDecimos" class="w-4 h-4 text-emerald-600 border-slate-300 rounded focus:ring-emerald-500 transition-all" checked>
                                <div class="ml-3 flex flex-col">
                                    <span class="text-sm font-bold text-slate-700 group-hover:text-emerald-700 transition-colors">Incluir Décimos (Mensualizados)</span>
                                    <span class="text-[11px] text-slate-400">Calcula la parte proporcional del 13vo y 14vo.</span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="space-y-3 sm:border-l sm:border-slate-100 sm:pl-6">
                        <h3 class="text-xs font-bold text-red-700 uppercase tracking-wider flex items-center gap-2 mb-4">
                            <i class="fas fa-minus-circle"></i> Deducciones
                        </h3>
                        <div>
                            <label for="valPrestamos" class="label-modern text-red-800/70">Anticipos / Préstamos ($)</label>
                            <div class="relative">
                                 <span class="absolute left-3 top-1/2 -translate-y-1/2 text-red-400 font-bold">$</span>
                                <input type="number" id="valPrestamos" value="0.00" min="0" step="0.01" class="input-modern pl-8 border-red-100 focus:border-red-400 focus:ring-red-500/20 text-red-600 font-medium bg-red-50/30 placeholder-red-300">
                            </div>
                        </div>
                         <div>
                            <label class="label-modern">Fecha de Emisión del Documento</label>
                            <input type="date" id="fechaEmision" class="input-modern text-slate-600">
                        </div>
                    </div>
                </div>

                <div class="mt-8 rounded-2xl overflow-hidden shadow-lg font-sans relative z-10">
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-800 to-slate-900 z-0"></div>
                    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-emerald-500/20 via-transparent to-transparent z-0"></div>
                    
                    <div class="relative z-10 p-6 text-white space-y-4">
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-slate-300 font-medium">Sueldo Proporcional:</span>
                                <span id="outSueldo" class="font-bold tracking-wide">$0.00</span>
                            </div>
                            
                            <div id="rowDecimos" class="hidden space-y-2 pl-4 border-l-2 border-emerald-500/50 my-3 py-1 transition-all">
                                <div class="flex justify-between items-center text-emerald-300">
                                    <span class="flex items-center gap-2"><i class="fas fa-gift text-xs"></i> Décimo 3ero (Proporcional):</span>
                                    <span id="outDec3" class="font-bold">$0.00</span>
                                </div>
                                <div class="flex justify-between items-center text-emerald-300">
                                    <span class="flex items-center gap-2"><i class="fas fa-graduation-cap text-xs"></i> Décimo 4to (Base SBU $470):</span>
                                    <span id="outDec4" class="font-bold">$0.00</span>
                                </div>
                            </div>

                            <div class="flex justify-between items-center text-red-200/80 pt-2 border-t border-white/10">
                                <span>Aporte Personal IESS (9.45%):</span>
                                <span id="outIess" class="font-medium">-$0.00</span>
                            </div>
                             <div class="flex justify-between items-center text-red-200/80">
                                <span>Descuento por Préstamos:</span>
                                <span id="outPrestamos" class="font-medium">-$0.00</span>
                            </div>
                        </div>

                        <div class="bg-white/5 p-4 rounded-xl border border-white/10 backdrop-blur-sm mt-4">
                            <div class="flex justify-between items-end">
                                <span class="text-sm font-bold text-emerald-400 uppercase tracking-widest">Total Líquido a Pagar</span>
                                <span id="outLiquido" class="text-3xl sm:text-4xl font-black text-white tracking-tight leading-none">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="guardarYGenerar()" class="group w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white font-bold text-base py-4 px-6 rounded-xl shadow-md hover:shadow-xl hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-3 relative overflow-hidden">
                    <span class="absolute inset-0 w-full h-full bg-white/20 group-hover:scale-[2.5] transition-transform duration-500 rounded-full opacity-0 group-hover:opacity-100 origin-center transform scale-0"></span>
                    <i class="fas fa-file-signature text-xl"></i>
                    <span>Procesar Pago y Generar Rol PDF</span>
                </button>

            </div>
        </div>


        <div class="lg:col-span-5 bg-white rounded-3xl shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] border border-slate-100 flex flex-col h-[800px] transition-all hover:shadow-[0_8px_30px_-6px_rgba(0,0,0,0.12)]">
            
            <div class="p-5 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-white rounded-t-3xl">
                <h2 class="font-bold text-lg text-slate-800 flex items-center gap-2.5">
                    <div class="bg-blue-500/10 p-2 rounded-lg">
                        <i class="fas fa-history text-blue-600"></i>
                    </div>
                    Historial de Pagos
                </h2>
                <div class="relative w-full sm:w-auto">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                    <input type="text" id="buscador" placeholder="Buscar hash o fecha..." class="input-modern pl-9 py-2 text-xs w-full bg-slate-50 focus:bg-white transition-colors">
                </div>
            </div>

            <div class="flex-1 overflow-auto custom-scroll bg-slate-50/50 p-4 rounded-b-3xl">
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-100/80 text-xs font-bold text-slate-600 uppercase tracking-wider sticky top-0 z-10 backdrop-blur-md">
                            <tr>
                                <th class="p-4 border-b border-slate-200 rounded-tl-xl">Transacción</th>
                                <th class="p-4 border-b border-slate-200 text-right">Pagado</th>
                                <th class="p-4 border-b border-slate-200 text-center rounded-tr-xl">Docs</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCuerpo" class="divide-y divide-slate-100 text-sm">
                            </tbody>
                    </table>
                </div>

                <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-slate-400">
                    <div class="bg-slate-100 p-4 rounded-full mb-4">
                        <i class="fas fa-cloud-download-alt text-4xl text-slate-300"></i>
                    </div>
                    <p class="font-medium text-slate-500 mb-1">No hay datos visualizados</p>
                    <p class="text-xs">Sincroniza para ver el historial reciente.</p>
                </div>
            </div>
        </div>
    </div>

    <canvas id="barcodeCanvas" class="hidden"></canvas>

    <script>
        // ==========================================
        // CONFIGURACIÓN 2025 (FIN DE AÑO)
        // ==========================================
        const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbwZIcwaAYvjIdGcWBStTBfuNnFUJYlIKr9V87P0Yxt1top6t0RB01iTRPuJOgRY2_Rg/exec";

        const DATOS = {
            empleador: { nombre: "DYLAN JOEL VELEZ VILLASAGUA", ci: "0926413667" },
            trabajador: { nombre: "MONICA ALEXANDRA MATUTE IBARRA", ci: "0201600202" },
            // DATOS EXACTOS DE LA USUARIA
            sueldoBase: 264.38, 
            sbu: 470.00,        // SBU OFICIAL 2025
            horasDiarias: 5.5   // 10:00 a 15:30
        };

        let hashActual = "";
        let dbLocal = []; 

        window.onload = () => {
            const hoy = new Date();
            // Fechas fijas para el cierre de Diciembre 2025
            document.getElementById('fechaIni').value = "2025-12-15";
            document.getElementById('fechaFin').value = "2025-12-31";
            document.getElementById('fechaEmision').valueAsDate = hoy;
            
            generarNuevoHash();
            calcular();
            cargarHistorial(); 
        };

        function generarNuevoHash() {
            const rand = Math.random().toString(36).substring(2, 6).toUpperCase();
            const mes = (new Date().getMonth() + 1).toString().padStart(2, '0');
            hashActual = `ROL-25-${mes}-${rand}`;
            document.getElementById('hashDisplay').innerText = hashActual;
        }

        ['fechaIni', 'fechaFin'].forEach(id => document.getElementById(id).addEventListener('change', calcular));
        ['valExtras', 'valPrestamos', 'checkDecimos'].forEach(id => document.getElementById(id).addEventListener('input', calcular));

        function calcular() {
            const d1 = new Date(document.getElementById('fechaIni').value);
            const d2 = new Date(document.getElementById('fechaFin').value);
            let dias = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
            if (dias < 0 || isNaN(dias)) dias = 0;
            document.getElementById('lblDias').innerText = dias;

            const extras = parseFloat(document.getElementById('valExtras').value) || 0;
            const prestamos = parseFloat(document.getElementById('valPrestamos').value) || 0;
            const conDecimos = document.getElementById('checkDecimos').checked;

            // --- CÁLCULOS 2025 ---
            // 1. Sueldo Proporcional
            const sueldoGanado = (DATOS.sueldoBase / 30) * dias;
            let dec3 = 0, dec4 = 0;
            
            if (conDecimos) {
                // 2. Décimo Tercero: (Total Ganado) / 12
                dec3 = (sueldoGanado + extras) / 12;
                
                // 3. Décimo Cuarto: SBU 470 * (5.5/8) = Base Proporcional
                // Luego se divide para 360 y se multiplica por días trabajados
                const factorProporcionalHoras = DATOS.horasDiarias / 8; // 0.6875
                const base14voAnual = DATOS.sbu * factorProporcionalHoras; // $323.125
                dec4 = (base14voAnual / 360) * dias;

                document.getElementById('rowDecimos').classList.remove('hidden');
            } else {
                document.getElementById('rowDecimos').classList.add('hidden');
            }

            const iess = (sueldoGanado + extras) * 0.0945;
            const liquido = (sueldoGanado + extras + dec3 + dec4) - iess - prestamos;

            document.getElementById('outSueldo').innerText = `$${sueldoGanado.toFixed(2)}`;
            if(conDecimos){
                document.getElementById('outDec3').innerText = `$${dec3.toFixed(2)}`;
                document.getElementById('outDec4').innerText = `$${dec4.toFixed(2)}`;
            }
            document.getElementById('outIess').innerText = `$${iess.toFixed(2)}`;
            document.getElementById('outPrestamos').innerText = `$${prestamos.toFixed(2)}`;
            document.getElementById('outLiquido').innerText = `$${liquido.toFixed(2)}`;

            return {
                dias, sueldoGanado, extras, dec3, dec4, iess, prestamos, liquido,
                periodoTxt: `${document.getElementById('fechaIni').value} al ${document.getElementById('fechaFin').value}`,
                emision: document.getElementById('fechaEmision').value
            };
        }

        async function cargarHistorial() {
            setLoading(true);
            try {
                const res = await fetch(URL_APPS_SCRIPT, { method: 'POST', body: JSON.stringify({ accion: 'leer' }) });
                const json = await res.json();
                if (json.result === 'success') { dbLocal = json.data; renderTabla(dbLocal); }
            } catch (e) { console.error(e); }
            setLoading(false);
        }

        async function guardarYGenerar() {
            if(URL_APPS_SCRIPT.includes("TU_URL")) return alert("¡Configura la URL del Script!");
            const calcs = calcular();
            if (calcs.dias <= 0) return alert("Revisa las fechas");
            setLoading(true);

            const payload = {
                hash: hashActual,
                periodo_txt: calcs.periodoTxt,
                monto: calcs.liquido.toFixed(2),
                detalle_completo: { ...calcs, ...DATOS } 
            };

            try {
                const res = await fetch(URL_APPS_SCRIPT, { method: 'POST', body: JSON.stringify({ accion: 'guardar', payload: payload }) });
                const json = await res.json();
                if (json.result === 'success') {
                    generarPDF(payload.detalle_completo, hashActual, 'ACTIVO');
                    generarNuevoHash();
                    cargarHistorial();
                } else { alert("Error guardando: " + json.msg); }
            } catch (e) { alert("Error de conexión"); }
            setLoading(false);
        }

        async function anularRol(hash) {
            if (!confirm("¿Anular este rol?")) return;
            setLoading(true);
            try {
                const res = await fetch(URL_APPS_SCRIPT, { method: 'POST', body: JSON.stringify({ accion: 'anular', hash: hash }) });
                const json = await res.json();
                if (json.result === 'success') cargarHistorial();
                else alert(json.msg);
            } catch (e) { alert("Error anulando"); }
            setLoading(false);
        }

        function generarPDF(data, hash, estado) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Fondo
            doc.setFillColor(245, 245, 245);
            for(let i=0; i<300; i+=10) { for(let j=0; j<300; j+=10) { doc.circle(i, j, 0.5, 'F'); } }

            if (estado === 'ANULADO') {
                doc.setTextColor(255, 200, 200); doc.setFontSize(60); doc.setFont("helvetica", "bold");
                doc.text("ANULADO", 50, 150, { angle: 45 }); doc.setTextColor(0,0,0);
            }

            doc.setFontSize(16); doc.setFont("helvetica", "bold");
            doc.text("ROL DE PAGOS - SERVICIO DOMÉSTICO 2025", 105, 20, null, null, "center");
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text(`CÓDIGO: ${hash}`, 105, 27, null, null, "center");
            doc.text(`PERÍODO: ${data.periodoTxt}`, 105, 33, null, null, "center");

            doc.setDrawColor(0); doc.setFillColor(255, 255, 255); doc.rect(15, 40, 180, 25, 'FD');
            doc.setFontSize(9);
            doc.text(`EMPLEADOR: ${data.empleador.nombre}`, 20, 48); doc.text(`CI: ${data.empleador.ci}`, 20, 53);
            doc.text(`TRABAJADORA: ${data.trabajador.nombre}`, 20, 60); doc.text(`CI: ${data.trabajador.ci}`, 140, 60);
            doc.text(`Sueldo Base: $${data.sueldoBase}`, 140, 48); doc.text(`Jornada: ${data.horasDiarias} Horas`, 140, 53);

            let y = 75;
            doc.setFillColor(30, 41, 59); doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255); doc.setFont("helvetica", "bold");
            doc.text("RUBRO", 20, y+5); doc.text("MONTO", 185, y+5, null, null, "right");
            
            y += 15; doc.setTextColor(0); doc.setFont("helvetica", "normal");
            const row = (label, val) => { doc.text(label, 20, y); doc.text(parseFloat(val).toFixed(2), 185, y, null, null, "right"); y += 7; };

            row(`Sueldo Proporcional (${data.dias} días)`, data.sueldoGanado);
            if(data.extras > 0) row("Horas Extras (+)", data.extras);
            if(data.dec3 > 0) row("Décimo 3ero (Mensualizado)", data.dec3);
            if(data.dec4 > 0) row("Décimo 4to (SBU $470)", data.dec4);
            row("Aporte IESS 9.45% (-)", data.iess);
            if(data.prestamos > 0) row("Préstamos (-)", data.prestamos);

            y += 5; doc.setLineWidth(0.5); doc.line(15, y, 195, y); y += 10;
            doc.setFontSize(12); doc.setFont("helvetica", "bold");
            doc.text("LÍQUIDO A RECIBIR:", 20, y); doc.text(`$ ${parseFloat(data.liquido).toFixed(2)}`, 185, y, null, null, "right");

            const canvas = document.createElement("canvas");
            JsBarcode(canvas, hash, { format: "CODE128", displayValue: false });
            y += 20; doc.addImage(canvas.toDataURL("image/jpeg"), 'JPEG', 70, y, 70, 15);
            
            y += 40; doc.line(30, y, 80, y); doc.line(130, y, 180, y);
            doc.setFontSize(8); doc.text("EMPLEADOR", 55, y+5, null, null, "center"); doc.text("RECIBÍ CONFORME", 155, y+5, null, null, "center");

            doc.save(`Rol_${hash}.pdf`);
        }

        function setLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
        
        function renderTabla(datos) {
            const tbody = document.getElementById('tablaCuerpo'); tbody.innerHTML = '';
            if(datos.length === 0) { document.getElementById('emptyState').classList.remove('hidden'); return; }
            document.getElementById('emptyState').classList.add('hidden');
            
            datos.forEach((item, index) => {
                const tr = document.createElement('tr');
                const esAnulado = item.estado === 'ANULADO';
                // Alternar colores de fila para mejor lectura
                tr.className = `transition-colors ${esAnulado ? 'row-anulado bg-red-50' : (index % 2 === 0 ? 'bg-white hover:bg-slate-50' : 'bg-slate-50/50 hover:bg-slate-100')}`;
                
                let dataObj = {}; try { dataObj = JSON.parse(item.json); } catch(e) {}
                const dataStr = JSON.stringify(dataObj).replace(/"/g, '&quot;');
                
                tr.innerHTML = `
                    <td class="p-4 cell-content">
                        <div class="font-bold text-slate-700 text-sm mb-1">${item.periodo}</div>
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-[10px] text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md border border-slate-200">${item.hash}</span>
                            ${esAnulado ? '<span class="no-strike text-[10px] font-bold text-red-700 bg-red-100 px-2 py-0.5 rounded-full flex items-center gap-1"><i class="fas fa-ban text-[8px]"></i> ANULADO</span>' : ''}
                        </div>
                    </td>
                    <td class="p-4 text-right font-black text-slate-800 text-base cell-content tracking-tight">$${item.liquido}</td>
                    <td class="p-4 text-center no-strike">
                        <div class="flex justify-center items-center gap-1">
                            <button onclick="generarPDF(${dataStr}, '${item.hash}', '${item.estado}')" class="p-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 rounded-lg transition-colors" title="Descargar PDF">
                                <i class="fas fa-file-pdf text-lg"></i>
                            </button>
                            ${!esAnulado ? 
                            `<button onclick="anularRol('${item.hash}')" class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Anular Rol">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>` : ''}
                        </div>
                    </td>`;
                tbody.appendChild(tr);
            });
        }
        
        function filtrarTabla() {
            const term = document.getElementById('buscador').value.toLowerCase();
            renderTabla(dbLocal.filter(x => x.hash.toLowerCase().includes(term) || x.periodo.toLowerCase().includes(term)));
        }
    </script>
</body>
</html>
