<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina Doméstica Pro 2025</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .security-bg { background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 10px 10px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #10b981; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .row-anulado { background-color: #fee2e2 !important; color: #991b1b; text-decoration: line-through; }
        .row-anulado .no-strike { text-decoration: none; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 font-sans text-slate-800">

    <div id="loadingOverlay" class="fixed inset-0 bg-white/80 z-50 hidden flex-col items-center justify-center">
        <div class="loader mb-2"></div>
        <p class="text-sm font-bold text-emerald-600">Procesando...</p>
    </div>

    <nav class="bg-slate-900 text-white p-4 rounded-xl shadow-lg max-w-6xl mx-auto mb-6 flex justify-between items-center">
        <h1 class="font-bold text-lg flex items-center gap-2">
            <i class="fas fa-file-invoice-dollar text-emerald-400"></i>
            <span>Nómina <span class="text-emerald-400 font-light">SecureCloud</span></span>
        </h1>
        <button onclick="cargarHistorial()" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded transition border border-slate-600">
            <i class="fas fa-sync-alt mr-1"></i> Recargar Datos
        </button>
    </nav>

    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6">

        <div class="bg-white rounded-xl shadow-xl border-t-4 border-slate-800 overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <h2 class="font-bold text-slate-700">Nuevo Rol de Pagos (2025)</h2>
                <span id="hashDisplay" class="text-[10px] font-mono bg-emerald-100 text-emerald-800 px-2 py-1 rounded border border-emerald-200">Generating...</span>
            </div>

            <div class="p-6 space-y-4 relative security-bg">
                <div class="text-xs bg-white/90 p-3 rounded border shadow-sm space-y-1">
                    <p><strong>Empleador:</strong> <span id="lblEmpleador">DYLAN JOEL VELEZ VILLASAGUA</span></p>
                    <p><strong>Trabajadora:</strong> <span id="lblTrabajador">MONICA ALEXANDRA MATUTE IBARRA</span></p>
                    <div class="flex justify-between mt-1 text-[10px] text-gray-500">
                        <span><i class="fas fa-clock"></i> Jornada: 5.5 Horas (10:00 - 15:30)</span>
                        <span class="font-bold text-emerald-600">Base: $270.00</span>
                    </div>
                </div>

                <div class="bg-blue-50/90 p-3 rounded border border-blue-100">
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-xs font-bold text-blue-800 uppercase">Período Laboral</span>
                        <span class="text-xs bg-white px-2 py-0.5 rounded text-blue-600 border border-blue-200 font-bold">
                            Días: <span id="lblDias">0</span>
                        </span>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <input type="date" id="fechaIni" class="w-full text-xs border rounded p-1.5 focus:ring-2 focus:ring-blue-400 outline-none">
                        <input type="date" id="fechaFin" class="w-full text-xs border rounded p-1.5 focus:ring-2 focus:ring-blue-400 outline-none">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs font-bold text-gray-600">Horas Extras ($)</label>
                        <input type="number" id="valExtras" value="0.00" class="w-full text-sm border rounded p-2 focus:border-emerald-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-600">Préstamos ($)</label>
                        <input type="number" id="valPrestamos" value="0.00" class="w-full text-sm border border-red-200 bg-red-50 text-red-600 rounded p-2 outline-none">
                    </div>
                </div>

                <div class="flex items-center gap-2 bg-gray-50 p-2 rounded border">
                    <input type="checkbox" id="checkDecimos" class="text-emerald-600 rounded focus:ring-emerald-500" checked>
                    <label for="checkDecimos" class="text-xs font-bold text-gray-700 cursor-pointer select-none">Mensualizar Décimos</label>
                </div>

                <div>
                    <label class="text-xs font-bold text-gray-500">Fecha de Firma (Emisión)</label>
                    <input type="date" id="fechaEmision" class="w-full text-xs border rounded p-1.5">
                </div>

                <div class="bg-slate-800 text-white p-4 rounded-lg shadow text-sm space-y-1">
                    <div class="flex justify-between text-gray-400 text-xs"><span>Sueldo Proporcional:</span> <span id="outSueldo">$0.00</span></div>
                    <div id="rowDecimos" class="hidden flex flex-col gap-1 border-t border-slate-600 pt-1 mt-1">
                        <div class="flex justify-between text-emerald-400 text-xs"><span>+ Décimo 3ero:</span> <span id="outDec3">$0.00</span></div>
                        <div class="flex justify-between text-emerald-400 text-xs"><span>+ Décimo 4to (Prop. 5.5h):</span> <span id="outDec4">$0.00</span></div>
                    </div>
                    <div class="flex justify-between text-red-300 text-xs pt-1"><span>- IESS (9.45%):</span> <span id="outIess">$0.00</span></div>
                    <div class="flex justify-between text-red-300 text-xs"><span>- Préstamos:</span> <span id="outPrestamos">$0.00</span></div>
                    <div class="border-t border-slate-600 my-2"></div>
                    <div class="flex justify-between font-bold text-lg text-yellow-400">
                        <span>A RECIBIR:</span> <span id="outLiquido">$0.00</span>
                    </div>
                </div>

                <button onclick="guardarYGenerar()" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-3 rounded-lg shadow-lg transition flex items-center justify-center gap-2">
                    <i class="fas fa-barcode"></i> Guardar y Generar PDF
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-xl border-t-4 border-blue-600 flex flex-col h-[600px]">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h2 class="font-bold text-slate-700 flex items-center gap-2">
                    <i class="fas fa-database text-blue-600"></i> Historial Cloud
                </h2>
                <input type="text" id="buscador" placeholder="Buscar..." class="text-xs border rounded px-2 py-1 w-32" onkeyup="filtrarTabla()">
            </div>

            <div class="flex-1 overflow-auto bg-slate-50 p-2">
                <table class="w-full text-xs text-left border-collapse bg-white shadow-sm rounded-lg overflow-hidden">
                    <thead class="bg-slate-200 text-slate-700 font-bold uppercase sticky top-0">
                        <tr>
                            <th class="p-3">Periodo / Hash</th>
                            <th class="p-3 text-right">Liquido</th>
                            <th class="p-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaCuerpo" class="divide-y divide-gray-100">
                        </tbody>
                </table>
                <div id="emptyState" class="hidden text-center p-10 text-gray-400">
                    <i class="fas fa-cloud-download-alt text-3xl mb-2"></i>
                    <p>Cargando datos...</p>
                </div>
            </div>
        </div>
    </div>

    <canvas id="barcodeCanvas" class="hidden"></canvas>

    <script>
        // ==========================================
        // CONFIGURACIÓN CORREGIDA 2025
        // ==========================================
        const URL_APPS_SCRIPT = "https://script.google.com/macros/s/AKfycbwZIcwaAYvjIdGcWBStTBfuNnFUJYlIKr9V87P0Yxt1top6t0RB01iTRPuJOgRY2_Rg/exec";

        const DATOS = {
            empleador: { nombre: "DYLAN JOEL VELEZ VILLASAGUA", ci: "0926413667" },
            trabajador: { nombre: "MONICA ALEXANDRA MATUTE IBARRA", ci: "0201600202" },
            // ACTUALIZADO: SUELDO BASE $270
            sueldoBase: 270.00, 
            // SBU NACIONAL (Para cálculo del 14vo)
            sbu: 460.00,       
            // HORAS REALES
            horasDiarias: 5.5  
        };

        let hashActual = "";
        let dbLocal = []; 

        window.onload = () => {
            const hoy = new Date();
            // Fechas por defecto para cierre 2024/Inicio 2025
            document.getElementById('fechaIni').value = "2024-12-15";
            document.getElementById('fechaFin').value = "2024-12-31";
            document.getElementById('fechaEmision').valueAsDate = hoy;
            
            generarNuevoHash();
            calcular();
            cargarHistorial(); 
        };

        function generarNuevoHash() {
            const rand = Math.random().toString(36).substring(2, 6).toUpperCase();
            const mes = (new Date().getMonth() + 1).toString().padStart(2, '0');
            hashActual = `ROL-${mes}-${rand}`;
            document.getElementById('hashDisplay').innerText = hashActual;
        }

        ['fechaIni', 'fechaFin'].forEach(id => document.getElementById(id).addEventListener('change', calcular));
        ['valExtras', 'valPrestamos', 'checkDecimos'].forEach(id => document.getElementById(id).addEventListener('input', calcular));

        function calcular() {
            const d1 = new Date(document.getElementById('fechaIni').value);
            const d2 = new Date(document.getElementById('fechaFin').value);
            let dias = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24)) + 1;
            if (dias < 0 || isNaN(dias)) dias = 0;
            document.getElementById('lblDias').innerText = dias;

            const extras = parseFloat(document.getElementById('valExtras').value) || 0;
            const prestamos = parseFloat(document.getElementById('valPrestamos').value) || 0;
            const conDecimos = document.getElementById('checkDecimos').checked;

            // --- CÁLCULOS 2025 ---
            const sueldoGanado = (DATOS.sueldoBase / 30) * dias;
            let dec3 = 0, dec4 = 0;
            
            if (conDecimos) {
                // 13vo: Todo lo ganado / 12
                dec3 = (sueldoGanado + extras) / 12;
                
                // 14vo: (SBU Nacional * Factor Horas) / 360 * Días
                const factorProporcionalHoras = DATOS.horasDiarias / 8; // 0.6875
                const base14voDiaria = (DATOS.sbu * factorProporcionalHoras) / 360;
                dec4 = base14voDiaria * dias;

                document.getElementById('rowDecimos').classList.remove('hidden');
            } else {
                document.getElementById('rowDecimos').classList.add('hidden');
            }

            const iess = (sueldoGanado + extras) * 0.0945;
            const liquido = (sueldoGanado + extras + dec3 + dec4) - iess - prestamos;

            document.getElementById('outSueldo').innerText = `$${sueldoGanado.toFixed(2)}`;
            if(conDecimos){
                document.getElementById('outDec3').innerText = `$${dec3.toFixed(2)}`;
                document.getElementById('outDec4').innerText = `$${dec4.toFixed(2)}`;
            }
            document.getElementById('outIess').innerText = `$${iess.toFixed(2)}`;
            document.getElementById('outPrestamos').innerText = `$${prestamos.toFixed(2)}`;
            document.getElementById('outLiquido').innerText = `$${liquido.toFixed(2)}`;

            return {
                dias, sueldoGanado, extras, dec3, dec4, iess, prestamos, liquido,
                periodoTxt: `${document.getElementById('fechaIni').value} al ${document.getElementById('fechaFin').value}`,
                emision: document.getElementById('fechaEmision').value
            };
        }

        async function cargarHistorial() {
            setLoading(true);
            try {
                const res = await fetch(URL_APPS_SCRIPT, { method: 'POST', body: JSON.stringify({ accion: 'leer' }) });
                const json = await res.json();
                if (json.result === 'success') { dbLocal = json.data; renderTabla(dbLocal); }
            } catch (e) { console.error(e); }
            setLoading(false);
        }

        async function guardarYGenerar() {
            if(URL_APPS_SCRIPT.includes("TU_URL")) return alert("¡Configura la URL del Script!");
            const calcs = calcular();
            if (calcs.dias <= 0) return alert("Revisa las fechas");
            setLoading(true);

            const payload = {
                hash: hashActual,
                periodo_txt: calcs.periodoTxt,
                monto: calcs.liquido.toFixed(2),
                detalle_completo: { ...calcs, ...DATOS } 
            };

            try {
                const res = await fetch(URL_APPS_SCRIPT, { method: 'POST', body: JSON.stringify({ accion: 'guardar', payload: payload }) });
                const json = await res.json();
                if (json.result === 'success') {
                    generarPDF(payload.detalle_completo, hashActual, 'ACTIVO');
                    generarNuevoHash();
                    cargarHistorial();
                } else { alert("Error guardando: " + json.msg); }
            } catch (e) { alert("Error de conexión"); }
            setLoading(false);
        }

        async function anularRol(hash) {
            if (!confirm("¿Anular este rol?")) return;
            setLoading(true);
            try {
                const res = await fetch(URL_APPS_SCRIPT, { method: 'POST', body: JSON.stringify({ accion: 'anular', hash: hash }) });
                const json = await res.json();
                if (json.result === 'success') cargarHistorial();
                else alert(json.msg);
            } catch (e) { alert("Error anulando"); }
            setLoading(false);
        }

        function generarPDF(data, hash, estado) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Fondo
            doc.setFillColor(245, 245, 245);
            for(let i=0; i<300; i+=10) { for(let j=0; j<300; j+=10) { doc.circle(i, j, 0.5, 'F'); } }

            if (estado === 'ANULADO') {
                doc.setTextColor(255, 200, 200); doc.setFontSize(60); doc.setFont("helvetica", "bold");
                doc.text("ANULADO", 50, 150, { angle: 45 }); doc.setTextColor(0,0,0);
            }

            doc.setFontSize(16); doc.setFont("helvetica", "bold");
            doc.text("ROL DE PAGOS - SERVICIO DOMÉSTICO", 105, 20, null, null, "center");
            doc.setFontSize(10); doc.setFont("helvetica", "normal");
            doc.text(`CÓDIGO: ${hash}`, 105, 27, null, null, "center");
            doc.text(`PERÍODO: ${data.periodoTxt}`, 105, 33, null, null, "center");

            doc.setDrawColor(0); doc.setFillColor(255, 255, 255); doc.rect(15, 40, 180, 25, 'FD');
            doc.setFontSize(9);
            doc.text(`EMPLEADOR: ${data.empleador.nombre}`, 20, 48); doc.text(`CI: ${data.empleador.ci}`, 20, 53);
            doc.text(`TRABAJADORA: ${data.trabajador.nombre}`, 20, 60); doc.text(`CI: ${data.trabajador.ci}`, 140, 60);
            doc.text(`Sueldo Base: $${data.sueldoBase}`, 140, 48); doc.text(`Jornada: ${data.horasDiarias} Horas`, 140, 53);

            let y = 75;
            doc.setFillColor(30, 41, 59); doc.rect(15, y, 180, 8, 'F');
            doc.setTextColor(255); doc.setFont("helvetica", "bold");
            doc.text("RUBRO", 20, y+5); doc.text("MONTO", 185, y+5, null, null, "right");
            
            y += 15; doc.setTextColor(0); doc.setFont("helvetica", "normal");
            const row = (label, val) => { doc.text(label, 20, y); doc.text(parseFloat(val).toFixed(2), 185, y, null, null, "right"); y += 7; };

            row(`Sueldo Proporcional (${data.dias} días)`, data.sueldoGanado);
            if(data.extras > 0) row("Horas Extras (+)", data.extras);
            if(data.dec3 > 0) row("Décimo 3ero (Mensualizado)", data.dec3);
            if(data.dec4 > 0) row("Décimo 4to (Prop. 5.5h)", data.dec4);
            row("Aporte IESS 9.45% (-)", data.iess);
            if(data.prestamos > 0) row("Préstamos (-)", data.prestamos);

            y += 5; doc.setLineWidth(0.5); doc.line(15, y, 195, y); y += 10;
            doc.setFontSize(12); doc.setFont("helvetica", "bold");
            doc.text("LÍQUIDO A RECIBIR:", 20, y); doc.text(`$ ${parseFloat(data.liquido).toFixed(2)}`, 185, y, null, null, "right");

            const canvas = document.createElement("canvas");
            JsBarcode(canvas, hash, { format: "CODE128", displayValue: false });
            y += 20; doc.addImage(canvas.toDataURL("image/jpeg"), 'JPEG', 70, y, 70, 15);
            
            y += 40; doc.line(30, y, 80, y); doc.line(130, y, 180, y);
            doc.setFontSize(8); doc.text("EMPLEADOR", 55, y+5, null, null, "center"); doc.text("RECIBÍ CONFORME", 155, y+5, null, null, "center");

            doc.save(`Rol_${hash}.pdf`);
        }

        function setLoading(s) { document.getElementById('loadingOverlay').style.display = s ? 'flex' : 'none'; }
        function renderTabla(datos) {
            const tbody = document.getElementById('tablaCuerpo'); tbody.innerHTML = '';
            if(datos.length === 0) { document.getElementById('emptyState').classList.remove('hidden'); return; }
            document.getElementById('emptyState').classList.add('hidden');
            datos.forEach(item => {
                const tr = document.createElement('tr');
                const esAnulado = item.estado === 'ANULADO';
                tr.className = `border-b hover:bg-slate-50 transition ${esAnulado ? 'row-anulado' : ''}`;
                let dataObj = {}; try { dataObj = JSON.parse(item.json); } catch(e) {}
                const dataStr = JSON.stringify(dataObj).replace(/"/g, '&quot;');
                tr.innerHTML = `
                    <td class="p-3"><div class="font-bold text-slate-700 text-xs">${item.periodo}</div><div class="font-mono text-[10px] text-slate-500 mt-1 flex gap-2"><span>${item.hash}</span>${esAnulado ? '<span class="text-red-600 font-bold px-1 border border-red-200 rounded no-strike">ANULADO</span>' : ''}</div></td>
                    <td class="p-3 text-right font-bold text-slate-800">$${item.liquido}</td>
                    <td class="p-3 text-center"><button onclick="generarPDF(${dataStr}, '${item.hash}', '${item.estado}')" class="text-blue-500 hover:text-blue-700 mx-1"><i class="fas fa-file-pdf"></i></button>${!esAnulado ? `<button onclick="anularRol('${item.hash}')" class="text-red-400 hover:text-red-600 mx-1"><i class="fas fa-ban"></i></button>` : ''}</td>`;
                tbody.appendChild(tr);
            });
        }
        function filtrarTabla() {
            const term = document.getElementById('buscador').value.toLowerCase();
            renderTabla(dbLocal.filter(x => x.hash.toLowerCase().includes(term) || x.periodo.toLowerCase().includes(term)));
        }
    </script>
</body>
</html>
