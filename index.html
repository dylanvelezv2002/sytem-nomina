<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plataforma de Roles</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --sidebar-bg: #1e293b;
            --sidebar-text: #e2e8f0;
            --accent: #3b82f6;
            --danger: #ef4444;
            --success: #10b981;
            --paper-width: 210mm;
            --paper-height: 297mm;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            background-color: #f1f5f9;
            overflow: hidden; /* Evita scroll en el body, solo en paneles */
        }

        /* --- 1. BARRA LATERAL (Editor) --- */
        .sidebar {
            width: 350px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            border-right: 1px solid #334155;
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            background-color: #0f172a;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-header h2 { margin: 0; font-size: 1.2rem; font-weight: 600; }
        .status-dot { height: 10px; width: 10px; background-color: #aaa; border-radius: 50%; display: inline-block; }

        .sidebar-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .form-section { margin-bottom: 25px; }
        .form-section h3 { 
            font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; 
            color: #94a3b8; margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 5px; 
        }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; margin-bottom: 5px; color: #cbd5e1; }
        .input-group input {
            width: 100%; box-sizing: border-box;
            background: #334155; border: 1px solid #475569;
            color: white; padding: 10px; border-radius: 6px;
            font-size: 0.9rem; transition: 0.2s;
        }
        .input-group input:focus { outline: none; border-color: var(--accent); background: #405069; }

        .sidebar-footer {
            padding: 20px;
            background-color: #0f172a;
            border-top: 1px solid #334155;
            display: grid; gap: 10px;
        }

        button {
            padding: 12px; border: none; border-radius: 6px;
            font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }
        .btn-ghost { background: transparent; color: #94a3b8; border: 1px solid #475569; }
        .btn-ghost:hover { background: #334155; color: white; }

        /* --- 2. √ÅREA DE VISUALIZACI√ìN (Preview) --- */
        .preview-area {
            flex: 1;
            background-color: #cbd5e1; /* Color escritorio */
            display: flex;
            justify-content: center;
            overflow-y: auto;
            padding: 40px;
        }

        /* --- 3. LA HOJA A4 (Dise√±o Profesional) --- */
        .sheet {
            width: var(--paper-width);
            min-height: var(--paper-height);
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 15mm;
            position: relative;
            box-sizing: border-box;
            color: #111;
        }

        /* Marca de Agua tipo "Sello de Tinta" */
        .stamp-anulado {
            display: none;
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%) rotate(-15deg);
            border: 5px double #d32f2f;
            color: #d32f2f;
            font-family: 'Courier New', Courier, monospace;
            font-size: 4rem;
            font-weight: 900;
            padding: 10px 20px;
            text-transform: uppercase;
            opacity: 0.6;
            z-index: 100;
            pointer-events: none;
            mix-blend-mode: multiply; /* Efecto de tinta real */
        }
        
        .sheet.is-void .stamp-anulado { display: block; }
        .sheet.is-void { opacity: 0.9; }

        /* Cabecera del Rol */
        .sheet-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;
        }
        .company-logo {
            width: 50px; height: 50px; background: #000; /* Placeholder logo */
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;
            margin-right: 15px;
        }
        .header-left { display: flex; align-items: center; }
        .header-title h1 { font-size: 1.4rem; margin: 0; text-transform: uppercase; letter-spacing: 1px; }
        .header-title p { margin: 0; font-size: 0.8rem; color: #555; }
        
        .rol-id-box {
            text-align: right;
            border: 1px solid #ccc; padding: 5px 10px; background: #f9f9f9;
        }
        .rol-id-box small { display: block; font-size: 0.6rem; color: #666; text-transform: uppercase; }
        .rol-id-box span { font-family: monospace; font-size: 1rem; font-weight: bold; }

        /* Informaci√≥n Empleado */
        .info-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-bottom: 20px; font-size: 0.9rem;
            background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #eee;
        }
        .info-item strong { display: block; font-size: 0.75rem; color: #666; text-transform: uppercase; }

        /* Tabla Financiera Limpia */
        .financial-table {
            width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-bottom: 30px;
        }
        .financial-table th {
            text-align: left; padding: 10px; border-bottom: 2px solid #333;
            text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.5px;
        }
        .financial-table td {
            padding: 10px; border-bottom: 1px solid #eee;
        }
        .col-money { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        
        .total-row td {
            border-top: 2px solid #333; border-bottom: none;
            font-weight: bold; font-size: 1.1rem; padding-top: 15px;
            background-color: rgba(0,0,0,0.02);
        }

        /* Firmas */
        .signatures {
            margin-top: 80px; display: flex; justify-content: space-between;
        }
        .sign-box {
            width: 40%; border-top: 1px solid #333; padding-top: 10px;
            text-align: center; font-size: 0.85rem;
        }

        /* Footer Seguridad */
        .security-footer {
            position: absolute; bottom: 10mm; left: 15mm; right: 15mm;
            text-align: center; font-size: 0.6rem; color: #999;
            border-top: 1px dotted #ccc; padding-top: 5px;
        }

        /* --- ESTILOS DE IMPRESI√ìN --- */
        @media print {
            body { background: white; height: auto; display: block; overflow: visible; }
            .sidebar { display: none; }
            .preview-area { display: block; padding: 0; background: white; }
            .sheet {
                box-shadow: none; margin: 0; width: 100%; 
                -webkit-print-color-adjust: exact; print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

    <aside class="sidebar no-print">
        <div class="sidebar-header">
            <h2>Gestion de N√≥mina</h2>
            <div id="statusDot" class="status-dot" title="Desconectado"></div>
        </div>

        <div class="sidebar-content">
            <div class="form-section">
                <h3>Datos Generales</h3>
                <div class="input-group">
                    <label>ID Documento</label>
                    <input type="text" id="inpId" placeholder="Ej: ROL-2025-001" onkeyup="updatePreview()">
                </div>
                <div class="input-group">
                    <label>Per√≠odo (Mes/A√±o)</label>
                    <input type="text" id="inpMes" value="Diciembre 2025" onkeyup="updatePreview()">
                </div>
            </div>

            <div class="form-section">
                <h3>Empleado</h3>
                <div class="input-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="inpNombre" placeholder="Nombre Apellido" onkeyup="updatePreview()">
                </div>
                <div class="input-group">
                    <label>C√©dula de Identidad</label>
                    <input type="text" id="inpCedula" placeholder="1712345678" onkeyup="updatePreview()">
                </div>
                <div class="input-group">
                    <label>Cargo</label>
                    <input type="text" id="inpCargo" placeholder="Analista" onkeyup="updatePreview()">
                </div>
            </div>

            <div class="form-section">
                <h3>Valores Econ√≥micos</h3>
                <div class="input-group">
                    <label>Sueldo Base ($)</label>
                    <input type="number" id="inpSueldo" value="0.00" step="0.01" onkeyup="updatePreview()">
                </div>
                <div class="input-group">
                    <label>Horas Extras ($)</label>
                    <input type="number" id="inpHE" value="0.00" step="0.01" onkeyup="updatePreview()">
                </div>
                <div class="input-group">
                    <label>Descuento IESS ($)</label>
                    <input type="number" id="inpIESS" value="0.00" step="0.01" onkeyup="updatePreview()">
                </div>
            </div>
        </div>

        <div class="sidebar-footer">
            <button class="btn-ghost" onclick="buscarRol()">
                <span>üîç</span> Buscar ID
            </button>
            <button class="btn-primary" id="btnGuardar" onclick="guardarRol()">
                <span>üíæ</span> Guardar Oficial
            </button>
            <button class="btn-danger" id="btnAnular" onclick="anularRol()" style="display: none;">
                <span>üö´</span> ANULAR
            </button>
            <button class="btn-ghost" onclick="window.print()" style="background: #e2e8f0; color: #0f172a;">
                <span>üñ®Ô∏è</span> Imprimir
            </button>
        </div>
    </aside>

    <main class="preview-area">
        <div id="hojaRol" class="sheet">
            <div class="stamp-anulado">ANULADO</div>

            <header class="sheet-header">
                <div class="header-left">
                    <div class="company-logo">G.R.</div> <div class="header-title">
                        <h1>Rol de Pagos Individual</h1>
                        <p>GAD PROVINCIAL / DEP. FINANCIERO</p>
                    </div>
                </div>
                <div class="rol-id-box">
                    <small>Nro. Control</small>
                    <span id="viewId">---</span>
                </div>
            </header>

            <div class="info-grid">
                <div class="info-item">
                    <strong>Empleado</strong>
                    <span id="viewNombre">---</span>
                </div>
                <div class="info-item">
                    <strong>C√©dula</strong>
                    <span id="viewCedula">---</span>
                </div>
                <div class="info-item">
                    <strong>Cargo</strong>
                    <span id="viewCargo">---</span>
                </div>
                <div class="info-item">
                    <strong>Per√≠odo de Pago</strong>
                    <span id="viewMes">---</span>
                </div>
            </div>

            <table class="financial-table">
                <thead>
                    <tr>
                        <th width="50%">Concepto</th>
                        <th class="col-money">Ingresos</th>
                        <th class="col-money">Descuentos</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Sueldo Unificado</td>
                        <td class="col-money" id="viewSueldo">0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Horas Suplementarias / Extraordinarias</td>
                        <td class="col-money" id="viewHE">0.00</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>Aporte Personal IESS (9.45%)</td>
                        <td></td>
                        <td class="col-money" id="viewIESS">0.00</td>
                    </tr>
                    <tr style="height: 100px; vertical-align: top;">
                        <td colspan="3" style="color: #ccc; padding-top: 20px;">/// Fin del detalle ///</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td>L√çQUIDO A RECIBIR</td>
                        <td colspan="2" class="col-money" id="viewLiquido" style="color: #000;">$ 0.00</td>
                    </tr>
                </tfoot>
            </table>

            <div class="signatures">
                <div class="sign-box">
                    <p><strong>Analista de N√≥mina</strong></p>
                    <br><br>
                    <p>Firma Autorizada</p>
                </div>
                <div class="sign-box">
                    <p><strong><span id="firmaEmpleado">Empleado</span></strong></p>
                    <br><br>
                    <p>C.I. <span id="firmaCedula">---</span></p>
                </div>
            </div>

            <div class="security-footer">
                Documento generado electr√≥nicamente. C√≥digo de Autenticidad: <span id="viewHash" style="font-family: monospace; color: #000;">NO-GUARDADO</span>
            </div>
        </div>
    </main>

    <script>
        // ==============================
        // CONFIGURACI√ìN API
        // ==============================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwZIcwaAYvjIdGcWBStTBfuNnFUJYlIKr9V87P0Yxt1top6t0RB01iTRPuJOgRY2_Rg/exec';

        // --- L√≥gica Visual ---
        function updatePreview() {
            // Mapping de inputs a vista
            document.getElementById('viewId').innerText = document.getElementById('inpId').value || '---';
            document.getElementById('viewMes').innerText = document.getElementById('inpMes').value || '---';
            
            const nombre = document.getElementById('inpNombre').value || '---';
            document.getElementById('viewNombre').innerText = nombre;
            document.getElementById('firmaEmpleado').innerText = nombre;
            
            const cedula = document.getElementById('inpCedula').value || '---';
            document.getElementById('viewCedula').innerText = cedula;
            document.getElementById('firmaCedula').innerText = cedula;

            document.getElementById('viewCargo').innerText = document.getElementById('inpCargo').value || '---';

            // C√°lculos
            const sueldo = parseFloat(document.getElementById('inpSueldo').value) || 0;
            const he = parseFloat(document.getElementById('inpHE').value) || 0;
            const iess = parseFloat(document.getElementById('inpIESS').value) || 0;

            document.getElementById('viewSueldo').innerText = sueldo.toFixed(2);
            document.getElementById('viewHE').innerText = he.toFixed(2);
            document.getElementById('viewIESS').innerText = iess.toFixed(2);

            const liquido = (sueldo + he) - iess;
            document.getElementById('viewLiquido').innerText = '$ ' + liquido.toFixed(2);
        }

        // --- L√≥gica de Base de Datos ---
        
        function setStatus(loading) {
            const dot = document.getElementById('statusDot');
            if (loading) {
                dot.style.backgroundColor = '#eab308'; // Amarillo (Cargando)
                dot.title = "Procesando...";
                document.body.style.cursor = 'wait';
            } else {
                dot.style.backgroundColor = '#10b981'; // Verde (Listo)
                dot.title = "Conectado";
                document.body.style.cursor = 'default';
            }
        }

        function guardarRol() {
            if(!confirm("¬øConfirmar registro oficial de este rol?")) return;
            setStatus(true);

            // Hash simple
            const hash = Math.random().toString(36).substring(2, 12).toUpperCase();
            document.getElementById('viewHash').innerText = hash;

            const payload = {
                id_unico: document.getElementById('inpId').value,
                mes: document.getElementById('inpMes').value,
                cedula: document.getElementById('inpCedula').value,
                empleado: document.getElementById('inpNombre').value,
                cargo: document.getElementById('inpCargo').value, // Agregado campo cargo
                sueldo: document.getElementById('inpSueldo').value,
                he: document.getElementById('inpHE').value,
                iess: document.getElementById('inpIESS').value,
                liquido_recibir: document.getElementById('viewLiquido').innerText,
                hash_seguridad: hash
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: 'guardar_nuevo', payload: payload })
            })
            .then(r => r.json())
            .then(data => {
                setStatus(false);
                if(data.result === 'success') {
                    alert("‚úÖ Guardado Exitoso");
                    document.getElementById('btnAnular').style.display = 'flex';
                    document.getElementById('btnGuardar').style.display = 'none';
                } else {
                    alert("‚ùå " + data.mensaje);
                }
            })
            .catch(e => { setStatus(false); alert("Error de red"); });
        }

        function buscarRol() {
            const id = document.getElementById('inpId').value;
            if(!id) return alert("Escribe un ID primero");
            setStatus(true);

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: 'buscar_completo', id_unico: id })
            })
            .then(r => r.json())
            .then(res => {
                setStatus(false);
                if(res.result === 'success') {
                    const d = res.data;
                    // Llenar formulario
                    document.getElementById('inpMes').value = d.mes;
                    document.getElementById('inpNombre').value = d.empleado;
                    document.getElementById('inpCedula').value = d.cedula;
                    document.getElementById('inpCargo').value = d.cargo || '';
                    document.getElementById('inpSueldo').value = d.sueldo;
                    document.getElementById('inpHE').value = d.he;
                    document.getElementById('inpIESS').value = d.iess;
                    document.getElementById('viewHash').innerText = d.hash_seguridad;

                    // Actualizar UI
                    updatePreview();

                    // Manejo Estado Anulado
                    const sheet = document.getElementById('hojaRol');
                    if(d.estado_actual === 'anulado') {
                        sheet.classList.add('is-void');
                        document.getElementById('btnAnular').style.display = 'none';
                        document.getElementById('btnGuardar').style.display = 'flex';
                        document.getElementById('btnGuardar').innerHTML = "<span>üíæ</span> Crear Nuevo (Reemplazo)";
                        alert("‚ö†Ô∏è ESTE ROL FUE ANULADO");
                    } else {
                        sheet.classList.remove('is-void');
                        document.getElementById('btnAnular').style.display = 'flex';
                        document.getElementById('btnGuardar').style.display = 'none';
                    }

                } else {
                    alert("No encontrado");
                    // Reset UI para crear nuevo
                    document.getElementById('hojaRol').classList.remove('is-void');
                    document.getElementById('btnGuardar').style.display = 'flex';
                    document.getElementById('btnGuardar').innerHTML = "<span>üíæ</span> Guardar Oficial";
                    document.getElementById('btnAnular').style.display = 'none';
                }
            });
        }

        function anularRol() {
            const motivo = prompt("Motivo de anulaci√≥n:");
            if(!motivo) return;
            setStatus(true);

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    accion: 'anular', 
                    id_unico: document.getElementById('inpId').value, 
                    motivo: motivo 
                })
            })
            .then(r => r.json())
            .then(d => {
                setStatus(false);
                if(d.result === 'success') {
                    document.getElementById('hojaRol').classList.add('is-void');
                    document.getElementById('btnAnular').style.display = 'none';
                    document.getElementById('btnGuardar').style.display = 'flex';
                    document.getElementById('btnGuardar').innerHTML = "<span>üíæ</span> Crear Nuevo (Reemplazo)";
                    alert("Rol Anulado");
                }
            });
        }

        // Init
        updatePreview();
    </script>
</body>
</html>
