<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nómina Doméstica - Sistema Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <div class="bg-white rounded-xl shadow-lg p-6 border-t-4 border-blue-600">
            <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">
                <i class="fas fa-file-invoice-dollar mr-2"></i>Generar Rol de Pagos
            </h2>

            <div class="bg-blue-50 p-3 rounded-lg text-xs text-blue-800 mb-4 space-y-1 border border-blue-100">
                <p><strong>Empleador:</strong> DYLAN JOEL VELEZ VILLASAGUA</p>
                <p><strong>Trabajador:</strong> MONICA ALEXANDRA MATUTE IBARRA</p>
                <p class="mt-1 text-[10px] text-gray-500">Los datos personales ya están cargados internamente.</p>
            </div>

            <div class="space-y-4">
                <div class="bg-gray-50 p-3 rounded border">
                    <p class="text-xs font-bold text-gray-500 mb-2 uppercase">Período de Pago</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-gray-700">Desde (Inicio)</label>
                            <input type="date" id="fechaInicio" class="w-full border rounded p-2 text-sm bg-white">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700">Hasta (Fin)</label>
                            <input type="date" id="fechaFin" class="w-full border rounded p-2 text-sm bg-white">
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-xs font-bold text-gray-700">Fecha de Emisión (Firma)</label>
                        <input type="date" id="fechaEmision" class="w-full border rounded p-2 text-sm bg-white">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Días Trabajados</label>
                        <input type="number" id="diasTrab" value="30" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-700">Horas Extras ($)</label>
                        <input type="number" id="extras" value="0.00" step="0.01" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="border p-3 rounded bg-blue-50 border-blue-100">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="pagarDecimos" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                        <span class="text-xs font-bold text-gray-700">¿Pagar Décimos este mes?</span>
                    </label>
                    
                    <div id="infoDecimos" class="hidden mt-2 ml-6 text-xs text-gray-600 space-y-1">
                        <div class="flex justify-between"><span>13º Sueldo:</span> <span id="view13" class="font-bold">$0.00</span></div>
                        <div class="flex justify-between"><span>14º Sueldo:</span> <span id="view14" class="font-bold">$0.00</span></div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-red-700">Anticipos o Préstamos ($)</label>
                    <input type="number" id="prestamos" value="0.00" step="0.01" class="w-full border border-red-200 rounded p-2 text-sm bg-red-50 focus:ring-2 focus:ring-red-200">
                </div>

                <div class="bg-gray-800 text-white p-4 rounded-lg mt-2 shadow-inner">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Sueldo Base:</span> <span id="viewBase">$264.38</span>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400 border-b border-gray-600 pb-1 mb-1">
                        <span>(Proporcional a <span id="viewDias">30</span> días)</span>
                    </div>

                    <div id="resumenDecimos" class="hidden text-green-400 text-sm mb-1">
                        <div class="flex justify-between"><span>+ Décimos (13º y 14º):</span> <span id="viewTotalDecimos">$0.00</span></div>
                    </div>
                    
                    <div class="flex justify-between text-sm text-red-300"><span>- IESS (9.45%):</span> <span id="viewIess">$24.98</span></div>
                    <div class="flex justify-between text-sm text-red-300"><span>- Préstamos:</span> <span id="viewPrestamos">$0.00</span></div>
                    
                    <div class="border-t border-gray-600 my-2"></div>
                    <div class="flex justify-between text-xl font-bold text-yellow-400">
                        <span>A PAGAR:</span> <span id="totalLiquido">$239.40</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="generarPDF()" class="bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg shadow-lg transition text-sm font-bold flex justify-center items-center">
                        <i class="fas fa-file-pdf mr-2"></i> Descargar Rol
                    </button>
                    <button onclick="guardarEnHistorial()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg shadow-lg transition text-sm font-bold flex justify-center items-center">
                        <i class="fas fa-save mr-2"></i> Guardar Historial
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col h-full border-t-4 border-green-600">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800"><i class="fas fa-history mr-2"></i>Historial Guardado</h2>
                <button onclick="exportarExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-xs font-bold transition flex items-center shadow">
                    <i class="fas fa-file-excel mr-1"></i> Bajar Excel
                </button>
            </div>
            
            <div class="overflow-auto flex-grow">
                <table class="w-full text-xs text-left">
                    <thead class="bg-gray-100 text-gray-600 uppercase">
                        <tr>
                            <th class="p-2 rounded-l">Período</th>
                            <th class="p-2">Pago ($)</th>
                            <th class="p-2 text-center">Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tablaHistorial" class="divide-y divide-gray-100">
                        </tbody>
                </table>
                <p id="emptyMsg" class="text-center text-gray-400 mt-10 text-sm">
                    <i class="fas fa-folder-open block text-2xl mb-2"></i>
                    No hay roles guardados todavía.
                </p>
            </div>
            <button onclick="borrarHistorial()" class="mt-4 text-xs text-red-400 hover:text-red-600 hover:underline text-center w-full transition">
                <i class="fas fa-trash-alt mr-1"></i> Borrar todo el historial
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN FIJA ---
        const CONFIG = {
            empleador: { nombre: "DYLAN JOEL VELEZ VILLASAGUA", ci: "0926413667", direccion: "AV. DR. HUMBERTO DEL POZO SALTOS (SECTOR HUMBERDINA)" },
            trabajador: { nombre: "MONICA ALEXANDRA MATUTE IBARRA", ci: "0201600202", cargo: "EMPLEADA DOMÉSTICA" },
            sueldoBaseFull: 264.38, // Para 30 días
            sbu2025: 470.00,        // SBU actual
            iessPorc: 0.0945
        };

        // Al cargar la página
        window.onload = function() {
            const today = new Date();
            // Poner fecha inicio (primer día del mes)
            const primerDia = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('fechaInicio').valueAsDate = primerDia;
            
            // Poner fecha fin (hoy o fin de mes)
            document.getElementById('fechaFin').valueAsDate = today;
            document.getElementById('fechaEmision').valueAsDate = today;
            
            cargarHistorial();
            calcularValores();
        };

        // Listeners para recalcular en tiempo real
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', calcularValores);
            input.addEventListener('change', calcularValores);
        });

        function calcularValores() {
            const dias = parseInt(document.getElementById('diasTrab').value) || 0;
            const extras = parseFloat(document.getElementById('extras').value) || 0;
            const prestamos = parseFloat(document.getElementById('prestamos').value) || 0;
            const incluyeDecimos = document.getElementById('pagarDecimos').checked;

            // 1. Sueldo Proporcional (Regla de tres si trabaja menos de 30 días)
            // Si quieres pagar fijo $264.38 aunque falte, cambia esta línea a: let sueldoGanado = CONFIG.sueldoBaseFull;
            let sueldoGanado = (CONFIG.sueldoBaseFull / 30) * dias;

            // 2. Cálculo de Décimos (Separados)
            let decimoTercero = 0;
            let decimoCuarto = 0;
            
            if (incluyeDecimos) {
                // 13ro: Todo lo ganado en el mes dividido para 12
                decimoTercero = (sueldoGanado + extras) / 12;
                
                // 14to: Un SBU ($470) dividido para 12 (Proporcional a días trabajados si no son 30)
                // Fórmula exacta: (SBU / 360) * días trabajados
                decimoCuarto = (CONFIG.sbu2025 / 360) * dias;

                // Mostrar desglose en pantalla
                document.getElementById('infoDecimos').classList.remove('hidden');
                document.getElementById('resumenDecimos').classList.remove('hidden');
            } else {
                document.getElementById('infoDecimos').classList.add('hidden');
                document.getElementById('resumenDecimos').classList.add('hidden');
            }

            // 3. IESS (9.45% del sueldo + extras)
            // OJO: Los décimos NO pagan IESS.
            let baseAportacion = sueldoGanado + extras;
            let aporteIess = baseAportacion * CONFIG.iessPorc;

            // 4. Total Líquido
            let totalIngresos = sueldoGanado + extras + decimoTercero + decimoCuarto;
            let totalEgresos = aporteIess + prestamos;
            let liquido = totalIngresos - totalEgresos;

            // Actualizar Vista HTML
            document.getElementById('viewBase').innerText = `$ ${sueldoGanado.toFixed(2)}`;
            document.getElementById('viewDias').innerText = dias;
            document.getElementById('view13').innerText = `$ ${decimoTercero.toFixed(2)}`;
            document.getElementById('view14').innerText = `$ ${decimoCuarto.toFixed(2)}`;
            document.getElementById('viewTotalDecimos').innerText = `$ ${(decimoTercero + decimoCuarto).toFixed(2)}`;
            document.getElementById('viewIess').innerText = `$ ${aporteIess.toFixed(2)}`;
            document.getElementById('viewPrestamos').innerText = `$ ${prestamos.toFixed(2)}`;
            document.getElementById('totalLiquido').innerText = `$ ${liquido.toFixed(2)}`;

            return { 
                sueldoGanado, extras, decimoTercero, decimoCuarto, 
                aporteIess, prestamos, liquido, totalIngresos, totalEgresos 
            };
        }

        // --- GENERADOR DE PDF ---
        function generarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const val = calcularValores();

            const fInicio = document.getElementById('fechaInicio').value.split('-').reverse().join('/');
            const fFin = document.getElementById('fechaFin').value.split('-').reverse().join('/');
            const fEmision = document.getElementById('fechaEmision').value.split('-').reverse().join('/');
            const dias = document.getElementById('diasTrab').value;

            // --- CABECERA ---
            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.text("ROL DE PAGOS INDIVIDUAL", 105, 20, null, null, 'center');
            
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`PERÍODO DE PAGO: DEL ${fInicio} AL ${fFin}`, 105, 28, null, null, 'center');

            // --- DATOS EMPRESA/EMPLEADO ---
            doc.setDrawColor(0);
            doc.setFillColor(245, 247, 250);
            doc.rect(14, 35, 182, 35, 'F'); // Fondo gris suave
            doc.rect(14, 35, 182, 35);      // Borde

            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            doc.text("EMPLEADOR:", 18, 42);
            doc.setFont("helvetica", "normal");
            doc.text(`${CONFIG.empleador.nombre}`, 60, 42);
            
            doc.setFont("helvetica", "bold");
            doc.text("RUC / C.I.:", 18, 48);
            doc.setFont("helvetica", "normal");
            doc.text(`${CONFIG.empleador.ci}`, 60, 48);

            doc.setFont("helvetica", "bold");
            doc.text("TRABAJADOR:", 18, 56);
            doc.setFont("helvetica", "normal");
            doc.text(`${CONFIG.trabajador.nombre}`, 60, 56);

            doc.setFont("helvetica", "bold");
            doc.text("C.I.:", 120, 56);
            doc.setFont("helvetica", "normal");
            doc.text(`${CONFIG.trabajador.ci}`, 130, 56);

            doc.setFont("helvetica", "bold");
            doc.text("CARGO:", 18, 62);
            doc.setFont("helvetica", "normal");
            doc.text(`${CONFIG.trabajador.cargo}`, 60, 62);

            // --- TABLA DE DETALLES ---
            let y = 80;
            
            // Encabezados Tabla
            doc.setFillColor(50, 50, 50); // Negro/Gris oscuro
            doc.rect(14, y, 182, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont("helvetica", "bold");
            doc.text("CONCEPTO", 18, y+5);
            doc.text("INGRESOS (+)", 120, y+5, null, null, 'right');
            doc.text("EGRESOS (-)", 170, y+5, null, null, 'right');
            
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            y += 14;

            // 1. Sueldo
            doc.text(`Sueldo Mensual (${dias} días trabajados)`, 18, y);
            doc.text(val.sueldoGanado.toFixed(2), 120, y, null, null, 'right');
            y += 6;

            // 2. Extras
            if(val.extras > 0) {
                doc.text("Horas Suplementarias / Extras", 18, y);
                doc.text(val.extras.toFixed(2), 120, y, null, null, 'right');
                y += 6;
            }

            // 3. Décimos (SEPARADOS)
            if(val.decimoTercero > 0 || val.decimoCuarto > 0) {
                doc.text("Décimo Tercer Sueldo (Mensualizado)", 18, y);
                doc.text(val.decimoTercero.toFixed(2), 120, y, null, null, 'right');
                y += 6;

                doc.text("Décimo Cuarto Sueldo (Mensualizado)", 18, y);
                doc.text(val.decimoCuarto.toFixed(2), 120, y, null, null, 'right');
                y += 6;
            }

            // 4. IESS
            doc.text("Aporte Personal IESS (9.45%)", 18, y);
            doc.text(val.aporteIess.toFixed(2), 170, y, null, null, 'right');
            y += 6;

            // 5. Préstamos
            if(val.prestamos > 0) {
                doc.text("Descuento Préstamos / Anticipos", 18, y);
                doc.text(val.prestamos.toFixed(2), 170, y, null, null, 'right');
                y += 6;
            }

            // --- TOTALES ---
            y += 4;
            doc.setLineWidth(0.5);
            doc.line(14, y, 196, y);
            y += 8;

            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.text("LÍQUIDO A RECIBIR:", 18, y);
            doc.text(`$ ${val.liquido.toFixed(2)}`, 170, y, null, null, 'right');

            // --- PIE DE PÁGINA / FIRMAS ---
            y += 15;
            doc.setFontSize(9);
            doc.setFont("helvetica", "normal");
            doc.text(`Fecha de Emisión: ${fEmision}`, 18, y);
            doc.text(`Dirección de Trabajo: ${CONFIG.empleador.direccion}`, 18, y+5);
            doc.text("Forma de Pago: TRANSFERENCIA BANCARIA", 18, y+10);

            // Firmas
            y += 35;
            doc.setLineWidth(0.2);
            doc.line(25, y, 85, y);  // Firma 1
            doc.line(125, y, 185, y); // Firma 2
            
            doc.text("EMPLEADOR", 40, y+5);
            doc.text("RECIBÍ CONFORME (Trabajadora)", 130, y+5);
            
            doc.text(`C.I.: ${CONFIG.empleador.ci}`, 40, y+10);
            doc.text(`C.I.: ${CONFIG.trabajador.ci}`, 135, y+10);

            // Guardar archivo
            const nombreArchivo = `Rol_${fInicio.replace(/\//g,'-')}_al_${fFin.replace(/\//g,'-')}.pdf`;
            doc.save(nombreArchivo);
        }

        // --- FUNCIONES DE HISTORIAL Y EXCEL ---
        function guardarEnHistorial() {
            const val = calcularValores();
            const registro = {
                id: Date.now(),
                periodo: `${document.getElementById('fechaInicio').value} al ${document.getElementById('fechaFin').value}`,
                liquido: val.liquido.toFixed(2),
                dias: document.getElementById('diasTrab').value,
                empleado: CONFIG.trabajador.nombre
            };

            let historial = JSON.parse(localStorage.getItem('nomina_db')) || [];
            historial.push(registro);
            localStorage.setItem('nomina_db', JSON.stringify(historial));
            cargarHistorial();
            alert("✅ Registro guardado en historial");
        }

        function cargarHistorial() {
            let historial = JSON.parse(localStorage.getItem('nomina_db')) || [];
            const tbody = document.getElementById('tablaHistorial');
            const emptyMsg = document.getElementById('emptyMsg');
            tbody.innerHTML = '';

            if(historial.length === 0) {
                emptyMsg.style.display = 'block';
                return;
            }
            emptyMsg.style.display = 'none';

            // Ordenar: más recientes primero
            historial.reverse().forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-2 border-b text-gray-700">${item.periodo}</td>
                    <td class="p-2 border-b font-bold text-gray-900">$${item.liquido}</td>
                    <td class="p-2 border-b text-center">
                        <button onclick="eliminarItem(${item.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function eliminarItem(id) {
            if(!confirm("¿Borrar este registro?")) return;
            let historial = JSON.parse(localStorage.getItem('nomina_db')) || [];
            historial = historial.filter(item => item.id !== id);
            localStorage.setItem('nomina_db', JSON.stringify(historial));
            cargarHistorial();
        }

        function borrarHistorial() {
            if(confirm("⚠ ¿Borrar TODO el historial de pagos?")) {
                localStorage.removeItem('nomina_db');
                cargarHistorial();
            }
        }

        function exportarExcel() {
            let historial = JSON.parse(localStorage.getItem('nomina_db')) || [];
            if(historial.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }
            const ws = XLSX.utils.json_to_sheet(historial);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Pagos");
            XLSX.writeFile(wb, "Historial_Nomina_Completo.xlsx");
        }
    </script>
</body>
</html>
