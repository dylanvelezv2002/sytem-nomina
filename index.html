<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Roles - Seguridad y Auditor√≠a</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        
        /* --- PANEL DE CONTROL (FORMULARIO) --- */
        .control-panel {
            background: white; padding: 20px; margin: 0 auto 20px auto;
            max-width: 800px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .form-group { display: flex; flex-direction: column; }
        label { font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        .btn-group { text-align: center; }
        button { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin: 5px; color: white; transition: 0.3s; }
        .btn-save { background-color: #28a745; }
        .btn-search { background-color: #007bff; }
        .btn-anular { background-color: #dc3545; }
        .btn-print { background-color: #6c757d; }
        button:hover { opacity: 0.9; transform: scale(1.05); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- HOJA A4 CON SEGURIDAD --- */
        .hoja-rol {
            position: relative;
            width: 210mm; /* A4 Ancho */
            min-height: 297mm; /* A4 Alto */
            margin: 0 auto;
            background-color: white;
            padding: 20mm;
            box-sizing: border-box;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            color: #333;
            overflow: hidden; /* Mantiene la marca de agua dentro */
            
            /* PATR√ìN DE SEGURIDAD (GUILLOCH√â SIMULADO) */
            background-image: 
                radial-gradient(#e0e0e0 15%, transparent 16%),
                radial-gradient(#e0e0e0 15%, transparent 16%);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            border: 1px solid #ccc;
        }

        /* --- MARCA DE AGUA "ANULADO" --- */
        .watermark-anulado {
            display: none; /* Oculto por defecto */
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 8rem;
            font-weight: 900;
            color: rgba(200, 0, 0, 0.25); /* Rojo semitransparente */
            border: 8px solid rgba(200, 0, 0, 0.25);
            padding: 10px 40px;
            text-transform: uppercase;
            z-index: 999;
            pointer-events: none;
            font-family: 'Courier New', Courier, monospace;
            white-space: nowrap;
        }

        /* CLASE ACTIVADORA */
        .hoja-rol.es-anulado .watermark-anulado { display: block; }
        .hoja-rol.es-anulado { filter: grayscale(10%); }

        /* --- CONTENIDO INTERNO DEL ROL --- */
        header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 30px; }
        .logo-box { font-size: 2em; font-weight: bold; margin-bottom: 5px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(255,255,255,0.9); }
        th, td { border: 1px solid #999; padding: 8px; text-align: left; }
        th { background-color: #eee; }
        .text-right { text-align: right; }

        .footer-section { margin-top: 60px; display: flex; justify-content: space-around; text-align: center; }
        .firma-box { border-top: 1px solid #000; width: 200px; padding-top: 5px; }

        .security-hash {
            font-family: monospace; font-size: 10px; color: #666;
            position: absolute; bottom: 10mm; right: 20mm;
        }

        /* --- ESTILOS DE IMPRESI√ìN --- */
        @media print {
            body { background: none; margin: 0; padding: 0; }
            .control-panel, .no-print { display: none !important; }
            .hoja-rol {
                margin: 0; box-shadow: none; border: none;
                -webkit-print-color-adjust: exact; /* Chrome/Safari */
                print-color-adjust: exact; /* Firefox */
            }
        }
    </style>
</head>
<body>

    <div class="control-panel no-print">
        <h2 style="text-align: center; margin-top: 0;">Gesti√≥n de Roles</h2>
        
        <div class="form-grid">
            <div class="form-group">
                <label>ID √önico (Ej: DIC-001)</label>
                <input type="text" id="inpId" placeholder="C√≥digo √önico del Rol" oninput="actualizarVistaPrevia()">
            </div>
            <div class="form-group">
                <label>Mes / A√±o</label>
                <input type="text" id="inpMes" value="Diciembre 2025" oninput="actualizarVistaPrevia()">
            </div>
            <div class="form-group">
                <label>C√©dula</label>
                <input type="text" id="inpCedula" placeholder="17..." oninput="actualizarVistaPrevia()">
            </div>
            <div class="form-group">
                <label>Nombre Empleado</label>
                <input type="text" id="inpNombre" placeholder="Nombre Apellido" oninput="actualizarVistaPrevia()">
            </div>
            <div class="form-group">
                <label>Sueldo Base ($)</label>
                <input type="number" id="inpSueldo" value="0" oninput="actualizarVistaPrevia()">
            </div>
            <div class="form-group">
                <label>Horas Extras ($)</label>
                <input type="number" id="inpHE" value="0" oninput="actualizarVistaPrevia()">
            </div>
            <div class="form-group">
                <label>Descuento IESS ($)</label>
                <input type="number" id="inpIESS" value="0" oninput="actualizarVistaPrevia()">
            </div>
        </div>

        <div class="btn-group">
            <button class="btn-search" onclick="buscarRol()">üîç Buscar por ID</button>
            <button class="btn-save" id="btnGuardar" onclick="guardarRol()">üíæ Guardar Nuevo</button>
            <button class="btn-anular" id="btnAnular" onclick="anularRol()" style="display:none;">üóëÔ∏è ANULAR ROL</button>
            <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir / PDF</button>
        </div>
        <p id="statusMsg" style="text-align: center; color: blue; font-weight: bold;"></p>
    </div>

    <div id="hojaRol" class="hoja-rol">
        
        <div class="watermark-anulado">ANULADO</div>

        <header>
            <div class="logo-box">EMPRESA XYZ S.A.</div>
            <h3>Comprobante de Pago de Haberes</h3>
            <p>RUC: 123456789001 | Direcci√≥n: Av. Principal y Calle 2</p>
        </header>

        <div style="margin-bottom: 30px;">
            <div class="info-row">
                <span><strong>Empleado:</strong> <span id="viewNombre">---</span></span>
                <span><strong>C√©dula:</strong> <span id="viewCedula">---</span></span>
            </div>
            <div class="info-row">
                <span><strong>Per√≠odo:</strong> <span id="viewMes">---</span></span>
                <span><strong>ID Rol:</strong> <span id="viewId">---</span></span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Concepto</th>
                    <th class="text-right">Ingresos</th>
                    <th class="text-right">Descuentos</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Sueldo Base</td>
                    <td class="text-right" id="viewSueldo">0.00</td>
                    <td class="text-right"></td>
                </tr>
                <tr>
                    <td>Horas Extras</td>
                    <td class="text-right" id="viewHE">0.00</td>
                    <td class="text-right"></td>
                </tr>
                <tr>
                    <td>Aporte IESS (9.45%)</td>
                    <td class="text-right"></td>
                    <td class="text-right" id="viewIESS">0.00</td>
                </tr>
            </tbody>
            <tfoot>
                <tr style="background: #f9f9f9; font-weight: bold;">
                    <td>TOTALES</td>
                    <td class="text-right" id="viewTotalIng">0.00</td>
                    <td class="text-right" id="viewTotalEgr">0.00</td>
                </tr>
                <tr style="background: #333; color: white;">
                    <td colspan="2" style="text-align: right;">L√çQUIDO A RECIBIR:</td>
                    <td class="text-right" style="font-size: 1.2em;" id="viewLiquido">0.00</td>
                </tr>
            </tfoot>
        </table>

        <div class="footer-section">
            <div class="firma-box">
                <p>Elaborado por</p>
                <p>Recursos Humanos</p>
            </div>
            <div class="firma-box">
                <p>Recib√≠ Conforme</p>
                <p id="firmaEmpleado">Empleado</p>
            </div>
        </div>

        <div class="security-hash">
            Hash Seguridad: <span id="viewHash">PENDIENTE-DE-GUARDADO</span>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACI√ìN: PEGA TU URL DE APPS SCRIPT AQU√ç
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwZIcwaAYvjIdGcWBStTBfuNnFUJYlIKr9V87P0Yxt1top6t0RB01iTRPuJOgRY2_Rg/exec'; 
        // Ejemplo: const API_URL = 'https://script.google.com/macros/s/AKfycbx.../exec';

        // --- Funciones de Interfaz ---

        function actualizarVistaPrevia() {
            // Pasa datos de los inputs a la hoja visual
            document.getElementById('viewId').innerText = document.getElementById('inpId').value;
            document.getElementById('viewMes').innerText = document.getElementById('inpMes').value;
            document.getElementById('viewCedula').innerText = document.getElementById('inpCedula').value;
            
            const nombre = document.getElementById('inpNombre').value;
            document.getElementById('viewNombre').innerText = nombre;
            document.getElementById('firmaEmpleado').innerText = nombre || "Empleado";

            // C√°lculos
            const sueldo = parseFloat(document.getElementById('inpSueldo').value) || 0;
            const he = parseFloat(document.getElementById('inpHE').value) || 0;
            const iess = parseFloat(document.getElementById('inpIESS').value) || 0;

            document.getElementById('viewSueldo').innerText = sueldo.toFixed(2);
            document.getElementById('viewHE').innerText = he.toFixed(2);
            document.getElementById('viewIESS').innerText = iess.toFixed(2);

            const totalIng = sueldo + he;
            const totalEgr = iess;
            const liquido = totalIng - totalEgr;

            document.getElementById('viewTotalIng').innerText = totalIng.toFixed(2);
            document.getElementById('viewTotalEgr').innerText = totalEgr.toFixed(2);
            document.getElementById('viewLiquido').innerText = '$ ' + liquido.toFixed(2);
        }

        // --- Funciones de Conexi√≥n (AJAX) ---

        function mostrarMensaje(msg) {
            document.getElementById('statusMsg').innerText = msg;
        }

        function guardarRol() {
            if(!confirm("¬øDesea guardar este rol oficial en la base de datos?")) return;
            mostrarMensaje("Guardando en la nube...");

            // 1. Generamos Hash de seguridad √∫nico
            const hash = Math.random().toString(36).substring(2, 10).toUpperCase();
            document.getElementById('viewHash').innerText = hash;

            // 2. Preparamos el paquete de datos (Snapshot)
            const payload = {
                id_unico: document.getElementById('inpId').value,
                mes: document.getElementById('inpMes').value,
                cedula: document.getElementById('inpCedula').value,
                empleado: document.getElementById('inpNombre').value,
                sueldo: document.getElementById('inpSueldo').value,
                he: document.getElementById('inpHE').value,
                iess: document.getElementById('inpIESS').value,
                liquido_recibir: document.getElementById('viewLiquido').innerText,
                hash_seguridad: hash
            };

            // 3. Enviamos
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: 'guardar_nuevo', payload: payload })
            })
            .then(r => r.json())
            .then(data => {
                mostrarMensaje(data.mensaje);
                if(data.result === 'success') {
                    alert("‚úÖ Rol guardado correctamente. Ahora puedes imprimir.");
                    // Habilitar anulaci√≥n
                    document.getElementById('btnAnular').style.display = 'inline-block';
                    document.getElementById('btnGuardar').disabled = true;
                } else {
                    alert("‚ùå Error: " + data.mensaje);
                }
            })
            .catch(e => mostrarMensaje("Error de conexi√≥n: " + e));
        }

        function buscarRol() {
            const idBuscar = document.getElementById('inpId').value;
            if(!idBuscar) return alert("Ingresa un ID para buscar");
            
            mostrarMensaje("Buscando en la base de datos...");
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: 'buscar_completo', id_unico: idBuscar })
            })
            .then(r => r.json())
            .then(resp => {
                if(resp.result === 'success') {
                    mostrarMensaje("Datos cargados.");
                    const data = resp.data;
                    
                    // Llenar inputs
                    document.getElementById('inpMes').value = data.mes;
                    document.getElementById('inpCedula').value = data.cedula;
                    document.getElementById('inpNombre').value = data.empleado;
                    document.getElementById('inpSueldo').value = data.sueldo;
                    document.getElementById('inpHE').value = data.he;
                    document.getElementById('inpIESS').value = data.iess;
                    document.getElementById('viewHash').innerText = data.hash_seguridad;

                    // Actualizar hoja visual
                    actualizarVistaPrevia();

                    // LOGICA DE ANULADO
                    const hoja = document.getElementById('hojaRol');
                    const btnAnular = document.getElementById('btnAnular');
                    const btnGuardar = document.getElementById('btnGuardar');

                    if(data.estado_actual === 'anulado') {
                        hoja.classList.add('es-anulado'); // Pone la marca de agua
                        btnAnular.style.display = 'none'; // No se puede anular lo anulado
                        btnGuardar.style.display = 'inline-block'; // Se permite guardar uno NUEVO con este ID si quisieras (o bloquealo si prefieres)
                        btnGuardar.innerText = "üíæ Crear Nuevo (Reemplazo)";
                        btnGuardar.disabled = false;
                        alert("‚ö†Ô∏è ATENCI√ìN: Este rol se encuentra ANULADO en el sistema.");
                    } else {
                        hoja.classList.remove('es-anulado');
                        btnAnular.style.display = 'inline-block';
                        btnGuardar.style.display = 'none'; // Ya existe, no guardar de nuevo
                    }

                } else {
                    mostrarMensaje("No encontrado.");
                    alert("No existe rol con ese ID. Puedes crear uno nuevo.");
                    // Resetear estado visual
                    document.getElementById('hojaRol').classList.remove('es-anulado');
                    document.getElementById('btnGuardar').style.display = 'inline-block';
                    document.getElementById('btnGuardar').innerText = "üíæ Guardar Nuevo";
                    document.getElementById('btnGuardar').disabled = false;
                    document.getElementById('btnAnular').style.display = 'none';
                }
            });
        }

        function anularRol() {
            const idRol = document.getElementById('inpId').value;
            const motivo = prompt("Ingrese el motivo de la anulaci√≥n (obligatorio):");
            
            if(!motivo) return alert("Cancelado: Se requiere un motivo.");

            mostrarMensaje("Procesando anulaci√≥n...");

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: 'anular', id_unico: idRol, motivo: motivo })
            })
            .then(r => r.json())
            .then(data => {
                if(data.result === 'success') {
                    alert("Rol ANULADO correctamente.");
                    document.getElementById('hojaRol').classList.add('es-anulado');
                    document.getElementById('btnAnular').style.display = 'none';
                    // Permitir crear uno nuevo
                    document.getElementById('btnGuardar').style.display = 'inline-block';
                    document.getElementById('btnGuardar').innerText = "üíæ Crear Nuevo (Reemplazo)";
                    document.getElementById('btnGuardar').disabled = false;
                } else {
                    alert("Error: " + data.mensaje);
                }
                mostrarMensaje(data.mensaje);
            });
        }

        // Inicializar
        actualizarVistaPrevia();
    </script>
</body>
</html>
