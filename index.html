<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rol de Pagos - Servicio Dom√©stico</title>
    <style>
        /* --- ESTILOS BASE (Para imprimir y ver) --- */
        body {
            font-family: 'Times New Roman', Times, serif; /* Tipograf√≠a legal cl√°sica */
            background-color: #555;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Formulario de llenado (Solo visible en pantalla) */
        .editor-container {
            background: #fff;
            width: 210mm;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif; /* Arial para el editor es m√°s f√°cil de leer */
        }
        
        .editor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .editor-section {
            grid-column: span 3;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #444;
        }

        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 12px; font-weight: bold; color: #666; margin-bottom: 3px; }
        .input-group input { padding: 5px; border: 1px solid #ccc; border-radius: 3px; }

        .toolbar {
            grid-column: span 3;
            text-align: right;
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        button {
            padding: 10px 20px; cursor: pointer; font-weight: bold;
            border: 1px solid #333; background: #fff; text-transform: uppercase;
        }
        button:hover { background: #eee; }
        .btn-save { background: #000; color: #fff; border: 1px solid #000; }
        .btn-anular { background: #8b0000; color: #fff; border: 1px solid #8b0000; }

        /* --- LA HOJA DE PAPEL (El Recibo) --- */
        .hoja-recibo {
            background: #fff;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            box-sizing: border-box;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            
            /* Trama de seguridad sutil */
            background-image: repeating-linear-gradient(
                45deg,
                #f9f9f9,
                #f9f9f9 1px,
                #fff 1px,
                #fff 4px
            );
            border: 1px solid #ccc;
        }

        /* Marca de Agua ANULADO */
        .sello-anulado {
            display: none;
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 100px;
            color: rgba(200, 0, 0, 0.4);
            border: 10px solid rgba(200, 0, 0, 0.4);
            padding: 20px;
            font-weight: bold;
            z-index: 99;
            pointer-events: none;
            text-transform: uppercase;
        }
        .hoja-recibo.anulado .sello-anulado { display: block; }
        
        /* Estructura del Recibo */
        h1 { text-align: center; font-size: 18pt; text-transform: uppercase; text-decoration: underline; margin-bottom: 30px; }
        
        .caja-datos {
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .fila-datos { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .label { font-weight: bold; width: 140px; }
        .valor { border-bottom: 1px dotted #999; flex: 1; margin-left: 10px; }

        .tabla-valores {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            margin-bottom: 30px;
        }
        .tabla-valores th, .tabla-valores td {
            border: 1px solid #000;
            padding: 8px;
        }
        .tabla-valores th { background-color: #eee; text-align: center; font-size: 11pt; }
        .derecha { text-align: right; }
        .centro { text-align: center; }

        .seccion-firmas {
            margin-top: 80px;
            display: flex;
            justify-content: space-between;
        }
        .firma-box {
            width: 40%;
            border-top: 1px solid #000;
            text-align: center;
            padding-top: 5px;
            font-size: 11pt;
        }

        .pie-legal {
            margin-top: 50px;
            font-size: 8pt;
            text-align: justify;
            color: #666;
        }

        .hash-seguridad {
            position: absolute; bottom: 10mm; right: 20mm;
            font-family: 'Courier New', monospace; font-size: 9pt;
        }

        /* --- MODO IMPRESI√ìN --- */
        @media print {
            body { background: none; margin: 0; padding: 0; }
            .editor-container, .no-print { display: none !important; }
            .hoja-recibo { box-shadow: none; margin: 0; width: 100%; border: none; }
        }
    </style>
</head>
<body>

    <div class="editor-container no-print">
        <h3 style="margin-top:0;">üìù Editar Datos del Rol</h3>
        <div class="editor-grid">
            
            <div class="editor-section">DATOS DEL EMPLEADOR</div>
            <div class="input-group">
                <label>Nombre Empleador</label>
                <input type="text" id="inEmpleador" placeholder="Nombre Apellido" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>C.I. / RUC Empleador</label>
                <input type="text" id="inRucEmpleador" placeholder="17..." oninput="actualizar()">
            </div>

            <div class="editor-section">DATOS DE LA TRABAJADORA</div>
            <div class="input-group">
                <label>Nombre Trabajadora</label>
                <input type="text" id="inTrabajador" placeholder="Nombre Apellido" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>C√©dula Trabajadora</label>
                <input type="text" id="inCedulaTrabajador" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>Cargo / Funci√≥n</label>
                <input type="text" id="inCargo" value="ASISTENTE DEL HOGAR" oninput="actualizar()">
            </div>

            <div class="editor-section">PER√çODO Y VALORES</div>
            <div class="input-group">
                <label>Fecha Desde</label>
                <input type="date" id="inDesde" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>Fecha Hasta</label>
                <input type="date" id="inHasta" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>D√≠as Trabajados</label>
                <input type="number" id="inDias" value="30" oninput="actualizar()">
            </div>
            
            <div class="input-group">
                <label>Sueldo Mensual ($)</label>
                <input type="number" id="inSueldo" value="460.00" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>Horas Extras ($)</label>
                <input type="number" id="inExtras" value="0.00" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>Transporte / Otros ($)</label>
                <input type="number" id="inOtrosIng" value="0.00" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>Aporte IESS 9.45% ($)</label>
                <input type="number" id="inIess" value="0.00" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>Anticipos / Pr√©stamos ($)</label>
                <input type="number" id="inAnticipos" value="0.00" oninput="actualizar()">
            </div>
            <div class="input-group">
                <label>ID Documento</label>
                <input type="text" id="inIdDoc" placeholder="Ej: ROL-DIC-2025" oninput="actualizar()">
            </div>

            <div class="toolbar">
                <span id="msgEstado" style="float: left; color: blue; font-weight: bold; padding-top: 10px;"></span>
                <button onclick="buscarRol()">üîç Buscar</button>
                <button class="btn-save" id="btnGuardar" onclick="guardarRol()">üíæ Guardar Oficial</button>
                <button class="btn-anular" id="btnAnular" onclick="anularRol()" style="display:none;">üö´ Anular Documento</button>
                <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
            </div>
        </div>
    </div>

    <div id="hojaPapel" class="hoja-recibo">
        <div class="sello-anulado">ANULADO</div>
        
        <h1>ROL DE PAGOS - SERVICIO DOM√âSTICO</h1>
        
        <p style="text-align: right; margin-bottom: 20px;">
            <strong>N¬∞ Documento:</strong> <span id="outIdDoc">---</span>
        </p>

        <div class="caja-datos">
            <div class="fila-datos">
                <span class="label">EMPLEADOR:</span>
                <span class="valor" id="outEmpleador"></span>
            </div>
            <div class="fila-datos">
                <span class="label">RUC / C.I.:</span>
                <span class="valor" id="outRucEmpleador"></span>
            </div>
        </div>

        <div class="caja-datos">
            <div class="fila-datos">
                <span class="label">TRABAJADORA:</span>
                <span class="valor" id="outTrabajador"></span>
            </div>
            <div class="fila-datos">
                <span class="label">C√âDULA:</span>
                <span class="valor" id="outCedulaTrabajador"></span>
            </div>
            <div class="fila-datos">
                <span class="label">CARGO:</span>
                <span class="valor" id="outCargo"></span>
            </div>
            <div class="fila-datos">
                <span class="label">PER√çODO:</span>
                <span class="valor">
                    Del <span id="outDesde">--/--/--</span> 
                    al <span id="outHasta">--/--/--</span>
                </span>
            </div>
            <div class="fila-datos">
                <span class="label">D√çAS LABORADOS:</span>
                <span class="valor" id="outDias"></span>
            </div>
        </div>

        <table class="tabla-valores">
            <thead>
                <tr>
                    <th>CONCEPTO</th>
                    <th>INGRESOS (+)</th>
                    <th>DESCUENTOS (-)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Sueldo Mensual Unificado</td>
                    <td class="derecha" id="outSueldo">0.00</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Horas Suplementarias / Extraordinarias</td>
                    <td class="derecha" id="outExtras">0.00</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Bonificaci√≥n Transporte / Otros</td>
                    <td class="derecha" id="outOtrosIng">0.00</td>
                    <td></td>
                </tr>
                <tr>
                    <td>Aporte Personal IESS (9.45%)</td>
                    <td></td>
                    <td class="derecha" id="outIess">0.00</td>
                </tr>
                <tr>
                    <td>Anticipos de Sueldo / Pr√©stamos</td>
                    <td></td>
                    <td class="derecha" id="outAnticipos">0.00</td>
                </tr>
                <tr style="font-weight: bold; background: #f0f0f0;">
                    <td class="derecha">SUBTOTALES:</td>
                    <td class="derecha" id="subIngresos">0.00</td>
                    <td class="derecha" id="subEgresos">0.00</td>
                </tr>
                <tr style="font-weight: bold; font-size: 14pt; border-top: 2px solid #000;">
                    <td class="derecha">L√çQUIDO A RECIBIR:</td>
                    <td colspan="2" class="centro" id="outLiquido">$ 0.00</td>
                </tr>
            </tbody>
        </table>

        <div class="seccion-firmas">
            <div class="firma-box">
                <br><br><br>
                <span id="firmaEmpleador">F. Empleador</span><br>
                <strong>EMPLEADOR</strong>
            </div>
            <div class="firma-box">
                <br><br><br>
                <span id="firmaTrabajador">F. Trabajadora</span><br>
                <strong>RECIB√ç CONFORME</strong><br>
                C.I.: <span id="cedulaFirma"></span>
            </div>
        </div>

        <div class="pie-legal">
            <p>Certifico que he recibido a mi entera satisfacci√≥n el valor indicado en este rol de pagos, no teniendo reclamo alguno presente ni futuro sobre los rubros aqu√≠ detallados.</p>
        </div>

        <div class="hash-seguridad">
            C√≥d. Autenticidad: <span id="outHash">BORRADOR</span>
        </div>
    </div>

    <script>
        // ==========================================
        //  PEGA AQU√ç TU URL DE GOOGLE APPS SCRIPT
        // ==========================================
        const API_URL = 'https://script.google.com/macros/s/AKfycbwZIcwaAYvjIdGcWBStTBfuNnFUJYlIKr9V87P0Yxt1top6t0RB01iTRPuJOgRY2_Rg/exec';

        // --- L√≥gica Visual ---
        function actualizar() {
            // Textos
            document.getElementById('outIdDoc').innerText = val('inIdDoc');
            document.getElementById('outEmpleador').innerText = val('inEmpleador');
            document.getElementById('firmaEmpleador').innerText = val('inEmpleador');
            document.getElementById('outRucEmpleador').innerText = val('inRucEmpleador');
            
            document.getElementById('outTrabajador').innerText = val('inTrabajador');
            document.getElementById('firmaTrabajador').innerText = val('inTrabajador');
            document.getElementById('outCedulaTrabajador').innerText = val('inCedulaTrabajador');
            document.getElementById('cedulaFirma').innerText = val('inCedulaTrabajador');
            
            document.getElementById('outCargo').innerText = val('inCargo');
            document.getElementById('outDesde').innerText = val('inDesde');
            document.getElementById('outHasta').innerText = val('inHasta');
            document.getElementById('outDias').innerText = val('inDias');

            // Valores
            const sueldo = num('inSueldo');
            const extras = num('inExtras');
            const otros = num('inOtrosIng');
            const iess = num('inIess');
            const anticipos = num('inAnticipos');

            const totIng = sueldo + extras + otros;
            const totEgr = iess + anticipos;
            const liquido = totIng - totEgr;

            // Renderizar Valores
            document.getElementById('outSueldo').innerText = sueldo.toFixed(2);
            document.getElementById('outExtras').innerText = extras.toFixed(2);
            document.getElementById('outOtrosIng').innerText = otros.toFixed(2);
            
            document.getElementById('outIess').innerText = iess.toFixed(2);
            document.getElementById('outAnticipos').innerText = anticipos.toFixed(2);

            document.getElementById('subIngresos').innerText = totIng.toFixed(2);
            document.getElementById('subEgresos').innerText = totEgr.toFixed(2);
            document.getElementById('outLiquido').innerText = '$ ' + liquido.toFixed(2);
        }

        // Helpers
        function val(id) { return document.getElementById(id).value; }
        function num(id) { return parseFloat(document.getElementById(id).value) || 0; }
        function msg(texto) { document.getElementById('msgEstado').innerText = texto; }

        // --- L√≥gica de Base de Datos ---

        function guardarRol() {
            if(!confirm("¬øConfirmar registro del pago?")) return;
            msg("Guardando...");

            const hash = Math.random().toString(36).substring(2, 10).toUpperCase();
            document.getElementById('outHash').innerText = hash;

            const payload = {
                id_unico: val('inIdDoc'),
                fecha_creacion: new Date(),
                empleador: val('inEmpleador'),
                trabajador: val('inTrabajador'),
                cedula: val('inCedulaTrabajador'),
                cargo: val('inCargo'),
                desde: val('inDesde'),
                hasta: val('inHasta'),
                liquido: document.getElementById('outLiquido').innerText,
                // Guardamos todo el estado del formulario para recuperarlo exacto
                data_completa: {
                    sueldo: val('inSueldo'),
                    extras: val('inExtras'),
                    otros: val('inOtrosIng'),
                    iess: val('inIess'),
                    anticipos: val('inAnticipos'),
                    dias: val('inDias'),
                    ruc_empleador: val('inRucEmpleador')
                },
                hash_seguridad: hash
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: 'guardar_nuevo', payload: payload })
            })
            .then(r => r.json())
            .then(res => {
                msg(res.mensaje);
                if(res.result === 'success') {
                    alert("Guardado Correctamente");
                    document.getElementById('btnAnular').style.display = 'inline-block';
                    document.getElementById('btnGuardar').disabled = true;
                } else {
                    alert("Error: " + res.mensaje);
                }
            });
        }

        function buscarRol() {
            const id = val('inIdDoc');
            if(!id) return alert("Ingrese ID");
            msg("Buscando...");

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ accion: 'buscar_completo', id_unico: id })
            })
            .then(r => r.json())
            .then(res => {
                if(res.result === 'success') {
                    msg("Datos cargados");
                    const d = res.data;
                    const full = d.data_completa || {}; // Data interna

                    // Llenar formulario
                    document.getElementById('inEmpleador').value = d.empleador || '';
                    document.getElementById('inRucEmpleador').value = full.ruc_empleador || '';
                    document.getElementById('inTrabajador').value = d.trabajador || '';
                    document.getElementById('inCedulaTrabajador').value = d.cedula || '';
                    document.getElementById('inCargo').value = d.cargo || '';
                    document.getElementById('inDesde').value = d.desde || '';
                    document.getElementById('inHasta').value = d.hasta || '';
                    document.getElementById('inDias').value = full.dias || 30;
                    
                    document.getElementById('inSueldo').value = full.sueldo || 0;
                    document.getElementById('inExtras').value = full.extras || 0;
                    document.getElementById('inOtrosIng').value = full.otros || 0;
                    document.getElementById('inIess').value = full.iess || 0;
                    document.getElementById('inAnticipos').value = full.anticipos || 0;
                    
                    document.getElementById('outHash').innerText = d.hash_seguridad;

                    actualizar();

                    // Manejo Estado
                    const hoja = document.getElementById('hojaPapel');
                    if(d.estado_actual === 'anulado') {
                        hoja.classList.add('anulado');
                        document.getElementById('btnAnular').style.display = 'none';
                        document.getElementById('btnGuardar').innerText = "Crear Copia Nueva";
                        document.getElementById('btnGuardar').disabled = false;
                        alert("Este rol est√° ANULADO");
                    } else {
                        hoja.classList.remove('anulado');
                        document.getElementById('btnAnular').style.display = 'inline-block';
                        document.getElementById('btnGuardar').disabled = true;
                    }
                } else {
                    msg("No encontrado");
                    alert("No existe registro con ese ID");
                    document.getElementById('btnGuardar').disabled = false;
                    document.getElementById('hojaPapel').classList.remove('anulado');
                }
            });
        }

        function anularRol() {
            const motivo = prompt("Motivo de la anulaci√≥n:");
            if(!motivo) return;
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    accion: 'anular', 
                    id_unico: val('inIdDoc'), 
                    motivo: motivo 
                })
            })
            .then(r => r.json())
            .then(res => {
                if(res.result === 'success') {
                    alert("Documento ANULADO");
                    document.getElementById('hojaPapel').classList.add('anulado');
                    document.getElementById('btnAnular').style.display = 'none';
                    document.getElementById('btnGuardar').disabled = false;
                    document.getElementById('btnGuardar').innerText = "Crear Nuevo";
                }
            });
        }
        
        // Iniciar
        actualizar();
    </script>
</body>
</html>
